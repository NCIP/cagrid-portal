<?xml version="1.0"?>

<project name="build-deploy file" basedir="." default="deploy">

	<property file="deploy.properties" />
	
	<property environment="env"/>
		
	<!-- Tomcat Properties -->
	<property name="tomcat.dir" value="${env.CATALINA_HOME}" />
	<property name="tomcat.common.lib.dir" value="${tomcat.dir}/common/lib" />
	<property name="tomcat.deploy.dir" value="${tomcat.dir}/webapps/wsrf/WEB-INF" />
	<property name="tomcat.deploy.lib.dir" value="${tomcat.deploy.dir}/lib" />
	<property name="tomcat.wsrf.schema.dir" value="${tomcat.dir}/webapps/wsrf/share/schema" />
	
	<!-- Relative path to Tomcat server configuration file -->
	<property name="tomcat.server.xml" value="/conf/server.xml" />
	
	<!-- Globus Toolkit Properties -->
	<property name="gt.dir" value="${env.GLOBUS_LOCATION}" />
	<property name="gt.lib.dir" value="${gt.dir}/lib" />
	
	
	<target name="deploy" description="Deploys to CATALINA_HOME" >
		
		<echo message="Deploying service under Tomcat at ${tomcat.dir}" />
		
		
		<!-- Configure Tomcat destination for skeletons -->
		<pathconvert dirsep="_" property="service.deployment.dir.name">
			<path>
				<pathelement path="${service.deployment.path}" />
			</path>
			<map from="${basedir}" to="" />
			<map from="/" to="" />
		</pathconvert>
		
		<property name="service.deployment.dir" value="${tomcat.deploy.dir}/etc/${service.deployment.dir.name}" />
		
		<!-- prepare the deployment directory -->
		<mkdir dir="${service.deployment.dir}" />
		
		<!-- prepare the server-config file -->
		<mkdir dir="tmp" />
		<copy overwrite="true" tofile="tmp/server-config.wsdd" file="server-config-template.wsdd" />
		<!-- replace the config paths in the server deploy file -->
		<replace file="tmp/server-config.wsdd" value="${service.deployment.dir.name}" token="SERVICE-INSTANCE-PATH" />
		<replace file="tmp/server-config.wsdd" value="${service.deployment.path}" token="SERVICE-INSTANCE-NAME" />
		<replace file="tmp/server-config.wsdd" value="etc/${service.deployment.dir.name}" token="ETC-PATH" />
		<replace file="tmp/server-config.wsdd" value="${service.deployment.dir}" token="ETC-FULL-PATH" />
		<copy overwrite="true" toDir="${service.deployment.dir}">
			<fileset dir="tmp">
				<include name="server-config.wsdd" />
			</fileset>
		</copy>
		
		<!-- prepare the jndi file -->
		<copy overwrite="true" tofile="tmp/jndi-config.xml" file="jndi-config-template.xml" />
		<!-- replace the config paths in the server deploy file -->
		<replace file="tmp/jndi-config.xml" value="${service.deployment.dir.name}" token="SERVICE-INSTANCE-PATH" />
		<replace file="tmp/jndi-config.xml" value="${service.deployment.path}" token="SERVICE-INSTANCE-NAME" />
		<replace file="tmp/jndi-config.xml" value="${service.deployment.dir}" token="ETC-FULL-PATH" />
		<copy overwrite="true" toDir="${service.deployment.dir}">
			<fileset dir="tmp">
				<include name="jndi-config.xml" />
			</fileset>
		</copy>
		
		<delete dir="tmp" />
		
		<!-- Copy skeleton files to Tomcat and rename -->
		<copy overwrite="true" toDir="${service.deployment.dir}">
			<fileset dir="${basedir}/etc">
				<include name="*" />
			</fileset>
		</copy>
		
		<!--copy over the jars to the lib -->
		<copy overwrite="true" toDir="${tomcat.deploy.lib.dir}">
			<fileset dir="lib">
				<include name="*" />
			</fileset>
			<fileset dir="build/lib">
				<include name="*" />
			</fileset>
		</copy>
		
		<!--copy over the schema service files-->
		<copy overwrite="true" toDir="${tomcat.wsrf.schema.dir}/${service.deployment.dir.name}">
			<fileset dir="build/schema/dorian">
				<include name="**\*" />
			</fileset>
		</copy>
		
		<!--copy over the schema service files-->
				<copy overwrite="true" toDir="${tomcat.dir}/common/endorsed">
					<fileset dir="ext/endorsed/lib">
						<include name="**\*" />
					</fileset>
				</copy>
	</target>

</project>
