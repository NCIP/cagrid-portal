<project name="certificate-tools" default="generate-certs">

	<import file="common.xml" />

	<target name="generate-service-ca-cert">
		<ant inheritAll="false" inheritRefs="false"
			antfile="${gridca-build-file}" target="generateCA">
			<property name="dn.input" value="${ca.service.dn.input}" />
			<property name="days.input"
				value="${ca.service.days.input}" />
			<property name="password.input"
				value="${ca.service.password.input}" />
			<property name="key.input" value="${ca.service.key.input}" />
			<property name="cert.input"
				value="${ca.service.cert.input}" />
		</ant>
	</target>

	<target name="generate-ca">
	
		<touch mkdirs="true" file="${ca.key.path}"/>
		<touch mkdirs="true" file="${ca.cert.path}"/>
		
		<ant inheritAll="false" inheritRefs="false"
			antfile="${gridca.build.file.path}" target="generateCA">
			<property name="dn.input" value="${ca.dn.input}" />
			<property name="days.input" value="${ca.days.valid}" />
			<property name="password.input" value="${ca.key.pwd}" />
			<property name="key.input" value="${ca.key.path}" />
			<property name="cert.input" value="${ca.cert.path}" />
		</ant>
	</target>

	<target name="generate-trust-ca-cert">
		<ant inheritAll="false" inheritRefs="false"
			antfile="${gridca-build-file}" target="generateCA">
			<property name="dn.input" value="${ca.trust.dn.input}" />
			<property name="days.input" value="${ca.trust.days.input}" />
			<property name="password.input"
				value="${ca.trust.password.input}" />
			<property name="key.input" value="${ca.trust.key.input}" />
			<property name="cert.input" value="${ca.trust.cert.input}" />
		</ant>
	</target>

	<target name="generate-dorian-ca-cert">
		<ant inheritAll="false" inheritRefs="false"
			antfile="${gridca-build-file}" target="generateCA">
			<property name="dn.input" value="${ca.dorian.dn.input}" />
			<property name="days.input" value="${ca.dorian.days.input}" />
			<property name="password.input"
				value="${ca.dorian.password.input}" />
			<property name="key.input" value="${ca.dorian.key.input}" />
			<property name="cert.input" value="${ca.dorian.cert.input}" />
		</ant>
	</target>

	<target name="generate-gts-service-cert">
		<ant inheritAll="false" inheritRefs="false"
			antfile="${gridca-build-file}"
			target="createAndSignHostCertificate">
			<property name="key.input" value="${ca.trust.key.input}" />
			<property name="password.input"
				value="${ca.trust.password.input}" />
			<property name="ca.input" value="${ca.trust.cert.input}" />
			<property name="hostname.input" value="${host}" />
			<property name="days.input" value="${host.days.input}" />
			<property name="hostkey.input"
				value="${certs.dir}/${host}.key" />
			<property name="cert.input"
				value="${certs.dir}/${host}.cert" />
		</ant>
	</target>

	<target name="generate-authn-ca-cert">
		<ant inheritAll="false" inheritRefs="false"
			antfile="${gridca-build-file}" target="generateCA">
			<property name="dn.input" value="${ca.authn.dn.input}" />
			<property name="days.input" value="${ca.authn.days.input}" />
			<property name="password.input"
				value="${ca.authn.password.input}" />
			<property name="key.input" value="${ca.authn.key.input}" />
			<property name="cert.input" value="${ca.authn.cert.input}" />
		</ant>
	</target>

	<target name="generate-host-certs">
		<for list="${nodes.list}" param="node" parallel="false">
			<sequential>
				<ant inheritAll="false" inheritRefs="false"
					antfile="${gridca-build-file}"
					target="createAndSignHostCertificate">
					<property name="key.input"
						value="${ca.service.key.input}" />
					<property name="password.input"
						value="${ca.service.password.input}" />
					<property name="ca.input"
						value="${ca.service.cert.input}" />
					<property name="hostname.input"
						value="${@{node}.host}" />
					<property name="days.input"
						value="${host.days.input}" />
					<property name="hostkey.input"
						value="${certs.dir}/${@{node}.host}.key" />
					<property name="cert.input"
						value="${certs.dir}/${@{node}.host}.cert" />
				</ant>
			</sequential>
		</for>
	</target>

	<target name="generate-host-creds">
	
		<touch mkdirs="true" file="${service.cert.path}"/>
		<touch mkdirs="true" file="${service.key.path}"/>
	
		<ant inheritAll="false" inheritRefs="false"
			antfile="${gridca.build.file.path}"
			target="createAndSignHostCertificate">
			<property name="key.input" value="${ca.key.path}" />
			<property name="password.input" value="${ca.key.pwd}" />
			<property name="ca.input" value="${ca.cert.path}" />
			<property name="hostname.input" value="${service.hostname}" />
			<property name="days.input"
				value="${service.cert.days.valid}" />
			<property name="hostkey.input" value="${service.key.path}" />
			<property name="cert.input" value="${service.cert.path}" />
		</ant>
	</target>

	<target name="generate-certs">
		<mkdir dir="${certs.dir}" />
		<antcall target="generate-service-ca-cert" />
		<antcall target="generate-trust-ca-cert" />
		<antcall target="generate-dorian-ca-cert" />
		<antcall target="generate-host-certs" />
		<antcall target="generate-authn-ca-cert" />
	</target>

</project>