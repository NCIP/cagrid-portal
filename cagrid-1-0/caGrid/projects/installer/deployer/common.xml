<project name="common">
	<property environment="env" />
	<property file="common.properties" />
	<property name="target.env" value="dev" />
	<property file="${target.env}.properties" />

	<path id="xmltaskdef.cp">
		<fileset dir="lib">
			<include name="xmltask-v1.14.jar" />
		</fileset>
	</path>

	<taskdef name="xmltask"
		classname="com.oopsconsultancy.xmltask.ant.XmlTask"
		classpathref="xmltaskdef.cp" />

	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<fileset dir="${cagrid.home}/share/lib">
				<include name="ant-contrib*.jar" />
			</fileset>
		</classpath>
	</taskdef>

	<target name="ssh">
		<if>
			<and>
				<isset property="username" />
				<isset property="password" />
			</and>
			<then>
				<sshexec host="${host}" username="${username}"
					password="${password}" command="${command}" />
			</then>
			<else>
				<sshexec host="${host}"
					keyfile="${user.home}/.ssh/id_dsa" command="${command}" />
			</else>
		</if>
	</target>

	<target name="scp">
		<if>
			<and>
				<isset property="username" />
				<isset property="password" />
			</and>
			<then>
				<scp file="${file}"
					remoteToFile="${username}:${password}@${host}:${remoteToFile}" />
			</then>
			<else>
				<scp file="${file}"
					remoteToDir="${host}:${remoteToFile}" />
			</else>
		</if>
	</target>

	<target name="deploy-service">
		<property name="build.dir"
			value="${basedir}/${temp.dir.path}/${deploy.service.name}-service" />
		<property name="zip.file.name"
			value="${deploy.service.name}-service.zip" />
		<property name="zip.file.path"
			value="${basedir}/${temp.dir.path}/${zip.file.name}" />
		<mkdir dir="${build.dir}" />
		<ant
			antfile="${cagrid.home}/projects/${deploy.service.name}/build.xml"
			inheritAll="false" inheritRefs="false" target="deployTomcat">
			<property name="tomcat.dir" value="${build.dir}" />
			<property name="index.service.url"
				value="http://${node1.host}:8080/wsrf/services/DefaultIndexService" />
		</ant>


		<zip destfile="${zip.file.path}" basedir="${build.dir}" />

		<scp file="${zip.file.path}"
			remoteToDir="${username}:${password}@${host}:~" />

		<sshexec host="${host}" username="${username}"
			password="${password}"
			command="echo ${password} | sudo -S chown -R globus:globus ${catalina.home}" />

		<sshexec host="${host}" username="${username}"
			password="${password}"
			command="unzip -o -q ~/${zip.file.name} -d ${catalina.home}" />

		<scp file="${ca.service.cert.input}"
			remoteToFile="${username}:${password}@${host}:~/.globus/certificates/${ca.service.cert.deploy.filename}" />
		<scp file="${ca.trust.cert.input}"
			remoteToFile="${username}:${password}@${host}:~/.globus/certificates/${ca.trust.cert.deploy.filename}" />
		<scp file="${ca.dorian.cert.input}"
			remoteToFile="${username}:${password}@${host}:~/.globus/certificates/${ca.dorian.cert.deploy.filename}" />

	</target>

	<target name="clean">
		<delete dir="${temp.dir.path}" />
		<delete dir="${certs.dir}" />
	</target>
</project>