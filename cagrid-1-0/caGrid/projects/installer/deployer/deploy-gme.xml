<project name="deploy-gme-service" default="deploy-gme-service">

	<import file="common.xml"/>

	<target name="deploy-gme-service">

		<propertyfile
			file="${cagrid.home}/projects/gme/deploy.properties">
			<entry key="service.deployment.host.default"
				value="${host}" />
			<entry key="service.deployment.host" value="${host}" />
		</propertyfile>

		<antcall target="configure-gme-globus-config" />
		<antcall target="configure-gme-registration" />

		<antcall target="deploy-service">
			<param name="deploy.service.name" value="gme" />
		</antcall>

	</target>

	<target name="configure-gme-registration">
		<property name="config.file"
			value="${cagrid.home}/projects/gme/etc/registration.xml" />
		<xmltask source="${config.file}" dest="${config.file}">
			<replace
				path="/*[local-name()='ServiceGroupRegistrationParameters']/*[local-name()='ServiceGroupEPR']/*[local-name()='Address']/text()"
				withText="http://${node1.host}:8080/wsrf/services/DefaultIndexService" />
		</xmltask>
	</target>

	<target name="configure-gme-globus-config">
		<property name="config.file"
			value="${cagrid.home}/projects/gme/etc/gme-globus-config.xml" />
		<xmltask source="${config.file}" dest="${config.file}">
			<replace
				path="/mobius/resource[@name='gmeConfig']/gmeConfiguration-configuration/root-database/host">
				<![CDATA[
		<host>${db.host}</host>
		]]>

			</replace>
			<replace
				path="/mobius/resource[@name='gmeConfig']/gmeConfiguration-configuration/root-database/port">
				<![CDATA[
		<port>${db.port}</port>
		]]>

			</replace>
			<replace
				path="/mobius/resource[@name='gmeConfig']/gmeConfiguration-configuration/root-database/username">
				<![CDATA[
		<username>${db.username}</username>
		]]>

			</replace>
			<replace
				path="/mobius/resource[@name='gmeConfig']/gmeConfiguration-configuration/root-database/password">
				<![CDATA[
		<password>${db.password}</password>
		]]>

			</replace>
		</xmltask>
	</target>

</project>