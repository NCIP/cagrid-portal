<project name="deploy-syncgts" default="deploy-syncgts-service">

	<import file="common.xml" />

	<target name="deploy-syncgts-service">

		<antcall target="configure-syncgts-service-properties" />
		<antcall target="configure-syncgts-sync-description" />
		<antcall target="deploy-service">
			<param name="deploy.service.name" value="syncgts" />
		</antcall>
		<scp
			file="${cagrid.home}/caGrid/projects/syncgts/lib/cog-jglobus.jar"
			remoteToFile="${username}:${password}@${host}:${catalina.home}/common/lib/cog-jglobus.jar" />

	</target>

	<target name="configure-syncgts-sync-description">
		<property name="config.file"
			value="${cagrid.home}/caGrid/projects/syncgts/etc/sync-description.xml" />
		<if>
			<or>
				<istrue value="${syncgts.isGTSMaster}" />
				<istrue value="${syncgts.isGTSSlave}" />
			</or>
			<then>
				<xmltask source="${config.file}"
					dest="${config.file}">
					<replace
						path="/*[local-name()='SyncDescription']/*[local-name()='SyncDescriptor']/*[local-name()='gtsServiceURI']/text()"
						withText="https://${node4.host}:8443/wsrf/services/cagrid/GTS" />
					<replace
						path="/*[local-name()='SyncDescription']/*[local-name()='SyncDescriptor']/*[local-name()='GTSIdentity']/text()"
						withText="${gts.service.identity.prefix}${node4.host}" />
				</xmltask>
			</then>
			<else>
				<xmltask source="${config.file}"
					dest="${config.file}">
					<replace
						path="/*[local-name()='SyncDescription']/*[local-name()='SyncDescriptor']/*[local-name()='gtsServiceURI']/text()"
						withText="https://${node5.host}:8443/wsrf/services/cagrid/GTS" />
					<replace
						path="/*[local-name()='SyncDescription']/*[local-name()='SyncDescriptor']/*[local-name()='GTSIdentity']/text()"
						withText="${gts.service.identity.prefix}${node5.host}" />
				</xmltask>
			</else>
		</if>
		<xmltask source="${config.file}" dest="${config.file}">
			<remove
				path="/*[local-name()='SyncDescription']/*[local-name()='SyncDescriptor']/*[local-name()='TrustedAuthorityFilter']" />
		</xmltask>
		<xmltask source="${config.file}" dest="${config.file}">
			<insert
				path="/*[local-name()='SyncDescription']/*[local-name()='SyncDescriptor']">
				<![CDATA[
					<ns1:TrustedAuthorityFilter xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ns2:TrustedAuthorityFilter" xmlns:ns1="http://cagrid.nci.nih.gov/12/SyncGTS" xmlns:ns2="http://cagrid.nci.nih.gov/8/gts">
					  <ns2:Lifetime xsi:type="ns2:Lifetime">Valid</ns2:Lifetime>
					  <ns2:Status xsi:type="ns2:Status">Trusted</ns2:Status>
					  <ns2:TrustLevels>
					    <ns2:TrustLevel>Service CAs</ns2:TrustLevel>
					  </ns2:TrustLevels>
					</ns1:TrustedAuthorityFilter>
					<ns1:TrustedAuthorityFilter xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ns2:TrustedAuthorityFilter" xmlns:ns1="http://cagrid.nci.nih.gov/12/SyncGTS" xmlns:ns2="http://cagrid.nci.nih.gov/8/gts">
					  <ns2:Lifetime xsi:type="ns2:Lifetime">Valid</ns2:Lifetime>
					  <ns2:Status xsi:type="ns2:Status">Trusted</ns2:Status>
					  <ns2:TrustLevels>
					    <ns2:TrustLevel>User CAs</ns2:TrustLevel>
					  </ns2:TrustLevels>
					</ns1:TrustedAuthorityFilter>
				]]>
			</insert>
		</xmltask>

		<xmltask source="${config.file}" dest="${config.file}">
			<remove
				path="/*[local-name()='SyncDescription']/*[local-name()='ExcludedCAs']/*[local-name()='CASubject']" />
			<insert
				path="/*[local-name()='SyncDescription']/*[local-name()='ExcludedCAs']">
				<![CDATA[
					<ns1:CASubject xmlns:ns1="http://cagrid.nci.nih.gov/12/SyncGTS">${ca.trust.dn.input}</ns1:CASubject>
				]]>
			</insert>
		</xmltask>
		<if>
			<or>
				<istrue value="${syncgts.isGTSMaster}" />
				<istrue value="${syncgts.isGTSSlave}" />
				<istrue value="${syncgts.isDorian}" />
			</or>
			<then>
				<xmltask source="${config.file}"
					dest="${config.file}">
					<insert
						path="/*[local-name()='SyncDescription']/*[local-name()='ExcludedCAs']">
						<![CDATA[
							<ns1:CASubject xmlns:ns1="http://cagrid.nci.nih.gov/12/SyncGTS">${ca.dorian.dn.input}</ns1:CASubject>
						]]>
					</insert>
				</xmltask>
			</then>
		</if>

		<xmltask source="${config.file}" dest="${config.file}">
			<replace
				path="/*[local-name()='SyncDescription']/*[local-name()='NextSync']/text()"
				withText="60" />
		</xmltask>

	</target>

	<target name="configure-syncgts-service-properties">
		<if>
			<istrue value="${syncgts.isGTSMaster}"/>
			<then>
				<propertyfile
					file="${cagrid.home}/caGrid/projects/syncgts/service.properties">
					<entry key="performFirstSync" value="false" />
				</propertyfile>
			</then>
			<else>
				<propertyfile
					file="${cagrid.home}/caGrid/projects/syncgts/service.properties">
					<entry key="performFirstSync" value="true" />
				</propertyfile>
			</else>
		</if>
	</target>
</project>