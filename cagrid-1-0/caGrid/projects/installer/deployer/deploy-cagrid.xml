<project name="deploy-cagrid" default="deploy-nodes">

	<import file="common.xml"/>
	<import file="tomcat-tools.xml"/>
	<import file="certificate-tools.xml"/>
	<import file="deploy-authn-service.xml"/>
	<import file="deploy-dorian.xml"/>
	<import file="deploy-gme.xml"/>
	<import file="deploy-gridgrouper.xml"/>
	<import file="deploy-gts.xml"/>
	<import file="deploy-index.xml"/>
	<import file="deploy-syncgts.xml"/>
	<import file="deploy-other-services.xml"/>

	<target name="sync-system-clocks">
		<input message="Username: " addproperty="host.username" />
		<input message="Password: " addproperty="host.password" />	
		<for list="${nodes.list}" param="node" parallel="false">
			<sequential>
				<antcall target="set-system-clock">
					<param name="username" value="${host.username}"/>
					<param name="password" value="${host.password}"/>
					<param name="host" value="${@{node}.host}" />
				</antcall>
			</sequential>
		</for>
	</target>

	<target name="set-system-clock">
		<tstamp>
			<format property="curr.time" pattern="MMddHHmmyyyy.ss" />
		</tstamp>	
		<sshexec host="${host}" username="${username}"
			password="${password}"
			command="echo ${password} | sudo -S date ${curr.time}" />
	</target>

	<target name="deploy-node1">
		<echo>Deploying services on host: ${host}</echo>
		<antcall target="deploy-index-service" />
		<antcall target="deploy-syncgts-service" />
	</target>

	<target name="deploy-node2">
		<echo>Deploying services on host: ${host}</echo>

		<antcall target="deploy-cadsr-service" />
		<antcall target="deploy-evs-service" />
		<antcall target="deploy-gme-service" />
		<antcall target="deploy-syncgts-service" />
	</target>

	<target name="deploy-node3">
		<echo>Deploying services on host: ${host}</echo>
		<antcall target="deploy-dorian-service" />
		<antcall target="deploy-syncgts-service" />
	</target>

	<target name="deploy-node4">
		<echo>Deploying services on host: ${host}</echo>
		<antcall target="deploy-gts-service">
			<param name="db.name" value="gts_master" />
		</antcall>
		<antcall target="deploy-syncgts-service">
			<param name="gts.isMaster" value="true" />
		</antcall>
	</target>

	<target name="deploy-node5">
		<echo>Deploying services on host: ${host}</echo>
		<antcall target="deploy-gts-service">
			<param name="db.name" value="gts_slave" />
		</antcall>
		<antcall target="deploy-syncgts-service">
			<param name="gts.isSlave" value="true" />
		</antcall>
	</target>

	<target name="deploy-node6">
		<echo>Deploying services on host: ${host}</echo>
		<antcall target="deploy-fqp-service" />
		<antcall target="deploy-syncgts-service" />
	</target>

	<target name="deploy-node7">
		<echo>Deploying services on host: ${host}</echo>
		<!-- antcall target="deploy-authn-service" / -->
		<antcall target="deploy-gridgrouper-service" />
		<antcall target="deploy-syncgts-service" />
	</target>

	<target name="deploy-nodes">
		<input message="Username: " addproperty="host.username" />
		<input message="Password: " addproperty="host.password" />
		<for list="${nodes.list}" param="node" parallel="false">
			<sequential>
				<antcall target="deploy-@{node}">
					<param name="username" value="${host.username}" />
					<param name="password" value="${host.password}" />
					<param name="host" value="${@{node}.host}" />
					<param name="temp.dir" value="${temp.dir}/@{node}" />
					<param name="catalina.home"
						value="${host.catalina.home}" />
				</antcall>
			</sequential>
		</for>
	</target>

</project>