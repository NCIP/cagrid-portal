<project name="deploy-dorian" default="deploy-dorian-service">

	<import file="common.xml" />

	<target name="deploy-dorian-service">

		<antcall target="configure-dorian-conf" />

		<antcall target="deploy-service">
			<param name="deploy.service.name" value="dorian" />
		</antcall>

	</target>

	<target name="configure-dorian-conf">


		<property name="dorian.config.ns" value="http://cagrid.nci.nih.gov/dorian/conf"/>
		
		<property name="config.file"
			value="${cagrid.home}/projects/dorian/etc/dorian-conf.xml" />
		<xmltask source="${config.file}" dest="${config.file}">
			<replace
				path="/*[local-name()='DorianConfiguration']/*[local-name()='DorianInternalId']">
				<![CDATA[
						<DorianInternalId xmlns="${dorian.config.ns}">${dorian.db.id}</DorianInternalId>
					]]>

			</replace>
			<replace
				path="/*[local-name()='DorianConfiguration']/*[local-name()='database']/*[local-name()='host']">
				<![CDATA[
					<host xmlns="${dorian.config.ns}">${dorian.db.host}</host>
				]]>

			</replace>
			<replace
				path="/*[local-name()='DorianConfiguration']/*[local-name()='database']/*[local-name()='port']">
				<![CDATA[
					<port xmlns="${dorian.config.ns}">${dorian.db.port}</port>
				]]>

			</replace>
			<replace
				path="/*[local-name()='DorianConfiguration']/*[local-name()='database']/*[local-name()='username']">
				<![CDATA[
					<username xmlns="${dorian.config.ns}">${dorian.db.username}</username>
				]]>

			</replace>
			<replace
				path="/*[local-name()='DorianConfiguration']/*[local-name()='database']/*[local-name()='password']">
				<![CDATA[
					<password xmlns="${dorian.config.ns}">${dorian.db.password}</password>
				]]>

			</replace>

			<replace
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityProviderConfiguration']/*[local-name()='IdentityProviderName']">
				<![CDATA[
						<IdentityProviderName xmlns="${dorian.config.ns}">${dorian.idp.name}</IdentityProviderName>
					]]>

			</replace>

			<attr attr="min"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityProviderConfiguration']/*[local-name()='UIDLength']"
				value="${dorian.idp.uid.min}" />

			<attr attr="max"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityProviderConfiguration']/*[local-name()='UIDLength']"
				value="${dorian.idp.uid.max}" />

			<attr attr="min"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityProviderConfiguration']/*[local-name()='PasswordLength']"
				value="${dorian.idp.pwd.min}" />

			<attr attr="max"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityProviderConfiguration']/*[local-name()='PasswordLength']"
				value="${dorian.idp.pwd.max}" />
		</xmltask>

		<if>
			<equals arg1="${dorian.idp.regpolicy}"
				arg2="Manual Registration" trim="true" />
			<then>
				<xmltask source="${config.file}"
					dest="${config.file}">
					<replace
						path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityProviderConfiguration']/*[local-name()='RegistrationPolicy']">
						<![CDATA[
						<RegistrationPolicy xmlns="${dorian.config.ns}">gov.nih.nci.cagrid.dorian.service.idp.ManualRegistrationPolicy</RegistrationPolicy>
						]]>
					</replace>
				</xmltask>
			</then>
			<else>
				<xmltask source="${config.file}"
					dest="${config.file}">
					<replace
						path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityProviderConfiguration']/*[local-name()='RegistrationPolicy']">
						<![CDATA[
						<RegistrationPolicy xmlns="${dorian.config.ns}">gov.nih.nci.cagrid.dorian.service.idp.AutomaticRegistrationPolicy</RegistrationPolicy>
						]]>
					</replace>
				</xmltask>
			</else>
		</if>

		<xmltask source="${config.file}" dest="${config.file}">
			<replace
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityProviderConfiguration']/*[local-name()='AssertingCredentials']/*[local-name()='AutoRenew']">
				<![CDATA[
						<AutoRenew xmlns="${dorian.config.ns}">${dorian.idp.saml.autorenew}</AutoRenew>
					]]>
			</replace>

			<replace
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityProviderConfiguration']/*[local-name()='AssertingCredentials']/*[local-name()='KeyPassword']">
				<![CDATA[
						<KeyPassword xmlns="${dorian.config.ns}">${dorian.idp.saml.keypwd}</KeyPassword>
					]]>
			</replace>

			<attr attr="min"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='IdentityProviderNameLength']"
				value="${dorian.ifs.idpname.min}" />

			<attr attr="max"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='IdentityProviderNameLength']"
				value="${dorian.ifs.idpname.max}" />

			<replace
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='IdentityAssignmentPolicy']">
				<![CDATA[
						<IdentityAssignmentPolicy xmlns="${dorian.config.ns}">${dorian.idp.idpolicy}</IdentityAssignmentPolicy>
					]]>
			</replace>

			<attr attr="years"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='CredentialPolicy']/*[local-name()='CredentialLifetime']"
				value="${dorian.ifs.credlifetime.years}" />
			<attr attr="months"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='CredentialPolicy']/*[local-name()='CredentialLifetime']"
				value="${dorian.ifs.credlifetime.months}" />
			<attr attr="days"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='CredentialPolicy']/*[local-name()='CredentialLifetime']"
				value="${dorian.ifs.credlifetime.days}" />
			<attr attr="hours"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='CredentialPolicy']/*[local-name()='CredentialLifetime']"
				value="${dorian.ifs.credlifetime.hours}" />
			<attr attr="minutes"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='CredentialPolicy']/*[local-name()='CredentialLifetime']"
				value="${dorian.ifs.credlifetime.minutes}" />
			<attr attr="seconds"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='CredentialPolicy']/*[local-name()='CredentialLifetime']"
				value="${dorian.ifs.credlifetime.seconds}" />

			<replace
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='CredentialPolicy']/*[local-name()='HostCertificateAutoApproval']">
				<![CDATA[
						<HostCertificateAutoApproval xmlns="${dorian.config.ns}">${dorian.ifs.hostcert.autoapprove}</HostCertificateAutoApproval>
					]]>
			</replace>

			<attr attr="hours"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='ProxyPolicy']/*[local-name()='ProxyLifetime']"
				value="${dorian.ifs.proxylifetime.hours}" />
			<attr attr="minutes"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='ProxyPolicy']/*[local-name()='ProxyLifetime']"
				value="${dorian.ifs.proxylifetime.minutes}" />
			<attr attr="seconds"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='ProxyPolicy']/*[local-name()='ProxyLifetime']"
				value="${dorian.ifs.proxylifetime.seconds}" />

			<remove
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']/*[local-name()='CRLPublish']" />
			<insert
				path="/*[local-name()='DorianConfiguration']/*[local-name()='IdentityFederationConfiguration']">
				<![CDATA[
				<CRLPublish xmlns="${dorian.config.ns}">
            		<gts xmlns="${dorian.config.ns}">${dorian.ifs.gts.url}</gts>
        		</CRLPublish>
				]]>
			</insert>

			<replace
				path="/*[local-name()='DorianConfiguration']/*[local-name()='DorianCAConfiguration']/*[local-name()='CertificateAuthorityPassword']">
				<![CDATA[
						<CertificateAuthorityPassword xmlns="${dorian.config.ns}">${dorian.ca.key.pwd}</CertificateAuthorityPassword>
					]]>
			</replace>
		</xmltask>
		<if>
			<isset property="dorian.ca.oid" />
			<then>
				<xmltask source="${config.file}"
					dest="${config.file}">
					<remove
						path="/*[local-name()='DorianConfiguration']/*[local-name()='DorianCAConfiguration']/*[local-name()='CertificatePolicyOID']" />
					<insert
						path="/*[local-name()='DorianConfiguration']/*[local-name()='DorianCAConfiguration']/*[local-name()='CertificateAuthorityPassword']"
						position="after">
						<![CDATA[
							<CertificatePolicyOID xmlns="${dorian.config.ns}">${dorian.ca.oid}</CertificatePolicyOID>
						]]>
					</insert>
				</xmltask>
			</then>
		</if>
		<xmltask source="${config.file}" dest="${config.file}">
			<replace
				path="/*[local-name()='DorianConfiguration']/*[local-name()='DorianCAConfiguration']/*[local-name()='UserKeySize']">
				<![CDATA[
						<UserKeySize xmlns="${dorian.config.ns}">${dorian.ca.userkey.size}</UserKeySize>
					]]>
			</replace>

		</xmltask>
		
		<remove path="/*[local-name()='DorianConfiguration']/*[local-name()='DorianCAConfiguration']/*[local-name()='AutoCreate']"/>
		<if>
			<not>
				<istrue value="${dorian.ca.present}"/>
			</not>
			<then>
				<xmltask source="${config.file}" dest="${config.file}">
					
					<insert position="after"
						path="/*[local-name()='DorianConfiguration']/*[local-name()='DorianCAConfiguration']/*[local-name()='UserKeySize']">
						<![CDATA[
						<AutoCreate xmlns="${dorian.config.ns}">
					        <CASubject xmlns="${dorian.config.ns}">${dorian.ca.subject}</CASubject>
					        <CAKeySize xmlns="${dorian.config.ns}">${dorian.ca.cakey.size}</CAKeySize>
					        <lifetime xmlns="${dorian.config.ns}" 
					               years="${dorian.ca.lifetime.years}" 
					               months="${dorian.ca.lifetime.months}" 
					               days="${dorian.ca.lifetime.days}" 
					               hours="${dorian.ca.lifetime.hours}" 
					               minutes="${dorian.ca.lifetime.minutes}" 
					               seconds="${dorian.ca.lifetime.seconds}"/>
					    </AutoCreate>
						]]>
					</insert>
				</xmltask>
			</then>
		</if>
		
		<xmltask source="${config.file}" dest="${config.file}">
			<attr attr="years"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='DorianCAConfiguration']/*[local-name()='AutoRenewal']"
				value="${dorian.ca.autorenew.years}" />
			<attr attr="months"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='DorianCAConfiguration']/*[local-name()='AutoRenewal']"
				value="${dorian.ca.autorenew.months}" />
			<attr attr="days"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='DorianCAConfiguration']/*[local-name()='AutoRenewal']"
				value="${dorian.ca.autorenew.days}" />
			<attr attr="hours"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='DorianCAConfiguration']/*[local-name()='AutoRenewal']"
				value="${dorian.ca.autorenew.hours}" />
			<attr attr="minutes"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='DorianCAConfiguration']/*[local-name()='AutoRenewal']"
				value="${dorian.ca.autorenew.minutes}" />
			<attr attr="seconds"
				path="/*[local-name()='DorianConfiguration']/*[local-name()='DorianCAConfiguration']/*[local-name()='AutoRenewal']"
				value="${dorian.ca.autorenew.seconds}" />
		</xmltask>

	</target>

</project>