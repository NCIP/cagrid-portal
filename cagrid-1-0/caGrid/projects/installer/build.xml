<project name="installer" default="all" basedir=".">
	
	<description>caGrid Installer build file</description>
	
	<property name="src" location="src" />
	<property name="build" location="build" />
	<property name="build.classes" location="${build}/classes" />
	<property name="build.jars" location="${build}/jars" />
	<property name="lib.dir" location="lib" />
	<property name="ext.lib.dir" location="ext/lib" />
	
	<property environment="env" />

	<property file="${basedir}/ext/resources/cagrid.properties" />
	
	<property name="project.jar.prefix"
		value="${cagrid.master.jar.prefix}${ant.project.name}" />
	
	
	<property name="download.properties.url" value="http://localhost:8080/downloads/cagrid.installer.properties"/>
	<property name="cagrid.download.url" value="http://localhost:8080/downloads/${cagrid.master.jar.prefix}src.zip"/>
	<property name="browser.download.url" value="http://localhost:8080/downloads/caGrid-1.1-browser.zip"/>
	

	<path id="build.classpath">
		<fileset dir="${lib.dir}" includes="**/*.jar" />
		<fileset dir="${ext.lib.dir}" includes="**/*.jar" />
	</path>
	<path id="run.classpath">
		<path refid="build.classpath"/>
		<pathelement location="${build.classes}"/>
	</path>

	<target name="init" depends="clean">
		<tstamp />
		<mkdir dir="${build}" />
		<mkdir dir="${build.classes}" />
		<mkdir dir="${build.jars}" />
	</target>

	<target name="compile" depends="init"
		description="compile the source ">

		<javac destdir="${build.classes}" source="1.5" debug="true">
			<src path="${src}" />
			<classpath refid="build.classpath" />
		</javac>

		<copy todir="${build.classes}">
			<fileset dir="${src}">
				<exclude name="**/*.java" />
				<exclude name="**/*.html" />
				<exclude name="**/*.psd" />
			</fileset>
		</copy>
	</target>

	<target name="clean" description="clean up">
		<delete dir="${build}" />
	</target>

	<target name="jar" depends="compile">
		
		<copy file="src/download.properties" todir="build/classes" overwrite="true">
			<filterset>
				<filter token="DOWNLOAD_PROPERTIES_URL" value="${download.properties.url}"/>
			</filterset>
		</copy>				
		
		<copy todir="build/classes" overwrite="true">
			<fileset dir="src">
				<include name="images/**"/>
				<!--
				<include name="resources/**"/>
				-->
				<include name="*.properties"/>
				<include name="*.txt"/>
				<exclude name="download.properties"/>
			</fileset>
		</copy>		
		
		<jar destfile="${build.jars}/${project.jar.prefix}.jar"
			basedir="${build.classes}"
			includes="org/cagrid/**/*.class **/*.properties **/*.txt images/**"
			manifest="manifest.txt"/>
	</target>

	<target name="all" depends="clean,compile,jar"></target>
	
	
	<target name="dist-installer" depends="jar" description="Generates an installer release.">

		<mkdir dir="build/installer/lib"/>
		<mkdir dir="build/installer/scripts/resources"/>
		
		<copy todir="build/installer" file="${build.jars}/${project.jar.prefix}.jar" overwrite="true"/>
		
		<copy todir="build/installer/lib">
			
			<fileset dir="../dorian/lib">
				<include name="mysql-connector*.jar"/>
			</fileset>

			<fileset dir="lib">
				<include name="commons-logging*.jar"/>
				<include name="log4j*.jar"/>
				<include name="xmltask*.jar"/>
				<include name="tools.jar"/>
				<include name="cog-jglobus.jar"/>
				<include name="jce-jdk13-125.jar"/>
				<include name="ant.jar"/>
			</fileset>
			
			<fileset dir="ext/lib">
				<include name="caGrid*wizard.jar"/>
			</fileset>
			
		</copy>
		
		<copy file="scripts/build.xml" todir="build/installer/scripts"/>
		<copy todir="build/installer/scripts/resources">
			<fileset dir="src/resources">
				<include name="**"/>			
			</fileset>
		</copy>
		
		<zip destfile="build/${project.jar.prefix}.zip" basedir="build/installer"/>
		
		<copy file="cagrid.installer.properties" todir="build" overwrite="true">
			<filterset>
				<filter token="CAGRID_DOWNLOAD_URL" value="${cagrid.download.url}"/>
				<filter token="BROWSER_DOWNLOAD_URL" value="${browser.download.url}"/>
			</filterset>
		</copy>
		
	</target>

</project>

