<project name="authz" default="all">
    
    <property file="build.properties"/>
    <property environment="env"/>
    <property name="globus.location" value="${env.GLOBUS_LOCATION}"/>
    <property name="build.dir" value="build"/>
    <property name="build.classes.dir" value="${build.dir}/classes"/>
    <property name="lib.dir" value="lib"/>
    <property name="ext.lib.dir" value="ext/lib"/>
    <property name="src.java.dir" value="src/java"/>
    <property name="test.src.java.dir" value="test/src/java"/>
    <property name="jar.name" value="caGrid-1.0-authz-common"/>
    
    <!-- Jars from GLOBUS_LOCATION/lib -->
    <patternset id="globus.jars">
        <include name="addressing-1.0.jar"/>
        <include name="axis.jar"/>
        <include name="bootstrap.jar"/>
        <include name="cog-axis.jar"/>
        <include name="cog-jglobus.jar"/>
        <include name="commonj.jar"/>
        <include name="commons-collections-3.0.jar"/>
        <include name="commons-discovery.jar"/>
        <include name="commons-logging.jar"/>
        <include name="concurrent.jar"/>
        <include name="cryptix-asn1.jar"/>
        <include name="cryptix.jar"/>
        <include name="cryptix32.jar"/>
        <include name="jaxrpc.jar"/>
        <include name="jce-jdk13-125.jar"/>
        <include name="jgss.jar"/>
        <include name="log4j-1.2.8.jar"/>
        <include name="naming-common.jar"/>
        <include name="naming-factory.jar"/>
        <include name="naming-java.jar"/>
        <include name="puretls.jar"/>
        <include name="resolver.jar"/>
        <include name="saaj.jar"/>
        <include name="wsdl4j.jar"/>
        <include name="wsrf_common.jar"/>
        <include name="wsrf_core_stubs.jar"/>
        <include name="wsrf_core.jar"/>
        <include name="wss4j.jar"/>
        <include name="xercesImpl.jar"/>
        <include name="xmlsec.jar"/>
        <include name="xml-apis.jar"/>
    </patternset>
    
    <!-- Jars from other caGrid projects -->
    <patternset id="cagrid.jars">
        <include name="caGrid-1.0-core.jar"/>
        <include name="caGrid-1.0-gridca.jar"/>
        <include name="caGrid-1.0-gridgrouper-client.jar"/>
        <include name="caGrid-1.0-gridgrouper-common.jar"/>
        <include name="caGrid-1.0-gridgrouper-stubs.jar"/>
        <include name="caGrid-1.0-metadata-common.jar"/>
        <include name="caGrid-1.0-metadata-security.jar"/>
        <include name="caGrid-1.0-ServiceSecurityProvider-client.jar"/>
        <include name="caGrid-1.0-ServiceSecurityProvider-common.jar"/>
        <include name="caGrid-1.0-ServiceSecurityProvider-service.jar"/>
        <include name="caGrid-1.0-ServiceSecurityProvider-stubs.jar"/>
        <include name="cglib-nodep-2.1_3.jar"/>
        <include name="grouper.jar"/>
    	<include name="hibernate3.jar" />
        <include name="jdom-1.0.jar" />    	
        <include name="junit.jar"/>
        <include name="mobius_common_client.jar"/>
        <include name="mobius_factories.jar"/>
        <include name="mobius_gme_client.jar"/>
        <include name="mobius_mako_client.jar"/>
        <include name="mobius_tools.jar"/>
    	<include name="spring.jar"/>
        <include name="subject-0.2.1.jar"/>
    </patternset>
    
    <!-- Jars from the CSM project's dist directory  -->
    <patternset id="csm.jars">
        <include name="antlr-2.7.6rc1.jar"/>
        <include name="c3p0-0.8.5.2.jar"/>
        <include name="clm.jar"/>
        <include name="commons-dbcp-1.2.1.jar"/>
        <include name="commons-lang-1.0.1.jar"/>
        <include name="csmapi.jar"/>
        <include name="dom4j-1.6.1.jar"/>
        <include name="ehcache-1.1.jar"/>
        <include name="jta.jar"/>
        <include name="jtds-1.2.jar"/>
        <include name="mysql-connector-java-3.1.11-bin.jar"/>
    </patternset>
    
    <path id="compile.cp">
        <fileset dir="${lib.dir}">
            <patternset refid="csm.jars"/>
        </fileset>
        <fileset dir="${ext.lib.dir}">
            <patternset refid="cagrid.jars"/>
        </fileset>
        <fileset dir="${globus.location}/lib">
            <patternset refid="globus.jars"/>
        </fileset>
    </path>
    
    <path id="run.cp">
        <path refid="compile.cp"/>
        <pathelement location="${build.dir}/${jar.name}.jar"/>
        <pathelement location="${build.classes.dir}"/>
    </path>
    
    
    <target name="init">
        <mkdir dir="${build.classes.dir}"/>
    </target>
    
    <target name="compile" depends="init">
        <javac srcdir="${src.java.dir}" destdir="${build.classes.dir}" debug="true">
            <classpath refid="compile.cp"/>
        </javac>
    </target>
    
    <target name="compile-test" depends="compile">
        <javac srcdir="${test.src.java.dir}" destdir="${build.classes.dir}" debug="true">
            <classpath refid="compile.cp"/>
        </javac>
    </target>
    
    <target name="jar" depends="compile">
        <jar basedir="${build.classes.dir}" destfile="build/${jar.name}.jar">
            <exclude name="*Test*.class"/>
        </jar>
    </target>

    
    <target name="test" depends="compile-test">
        
        <junit printsummary="yes" showoutput="true" fork="true">
            
            <jvmarg value="-Dgov.nih.nci.security.configFile=test/etc/ApplicationSecurityConfig.xml"/>
            <jvmarg value="-Djava.security.auth.login.config=test/etc/jaas.config"/>
            

            <classpath refid="run.cp"/>


            <formatter type="plain"/>
            <test name="gov.nih.nci.cagrid.authorization.GridAuthorizationTestCase" haltonfailure="no" outfile="test/authz-junit"/>

        </junit>
    </target>
    
    <target name="clean">
        <delete dir="build"/>
    </target>
    
    <target name="all" depends="clean, jar"/>
    
    <target name="package-authz-jars" depends="jar">
        <zip destfile="${build.dir}/authz-jars.zip">
            <fileset dir="${lib.dir}">
                <patternset refid="other.jars"/>
                <!--
                <patternset refid="csm.jars"/>
                -->
            </fileset>
            <fileset dir="${ext.lib.dir}">
                <patternset refid="cagrid.jars"/>
            </fileset>
            <fileset dir="${globus.location}/lib">
                <patternset refid="globus.jars"/>
            </fileset>
            <fileset dir="${build.dir}">
                <include name="${jar.name}.jar"/>
            </fileset>
        </zip>
    </target>
    
</project>