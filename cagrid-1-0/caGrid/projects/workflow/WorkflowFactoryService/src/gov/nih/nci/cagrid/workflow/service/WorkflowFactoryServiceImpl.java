package gov.nih.nci.cagrid.workflow.service;

import gov.nih.nci.cagrid.common.Utils;
import gov.nih.nci.cagrid.workflow.stubs.types.WMSInputType;
import gov.nih.nci.cagrid.workflow.stubs.types.WMSOutputType;
import gov.nih.nci.cagrid.workflow.stubs.types.WSDLReferences;

import java.io.File;
import java.rmi.RemoteException;


/** 
 *  TODO:DOCUMENT ME
 * 
 * @created by Introduce Toolkit version 1.0
 * 
 */
public class WorkflowFactoryServiceImpl extends WorkflowFactoryServiceImplBase {

	public static String BPEL_EXTENSION = ".bpel";
	
	protected String abAdminRoot = "http://localhost:8080/active-bpel/services/";
	
	public WorkflowFactoryServiceImpl() throws RemoteException {
		super();
	}
	

	public WMSOutputType createWorkflow(WMSInputType wMSInputElement) throws RemoteException, gov.nih.nci.cagrid.workflow.stubs.types.WorkflowExceptionType {
		//TODO: Implement this autogenerated method
		String workflowName = wMSInputElement.getWorkflowName();
		String bpelProcess = wMSInputElement.getBpelDoc();
		WMSOutputType output = new WMSOutputType();
		System.out.println(workflowName + " " + bpelProcess);
		File bpelFile = null;
		try {
			String bpelFileName = System.getProperty("java.io.tmpdir")
					+ File.separator + workflowName + BPEL_EXTENSION;
			bpelFile = new File(bpelFileName);
			bpelFile.deleteOnExit();
			Utils.stringBufferToFile(new StringBuffer(bpelProcess),
					bpelFileName);
			WSDLReferences[] wsdlRefArray = wMSInputElement.getWsdlReferences();
			String returnString = deploy(bpelFileName, workflowName, wsdlRefArray);
			System.out.println(returnString);
		} catch (Exception e){
			throw new RemoteException ("Exception deploying workflow:"+ workflowName ,e );
		}
		return output;
	}

	private String deploy(String bpelFileName, String workflowName, WSDLReferences[] wsdlRefArray) throws Exception {
        String abAdminUrl = this.abAdminRoot + "BpelEngineAdmin";
		return ActiveBPELAdapter.deployBpr(abAdminUrl, bpelFileName ,workflowName, wsdlRefArray);
	}
}

