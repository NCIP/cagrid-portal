<?xml version="1.0" encoding="UTF-8"?>
<!--
BPEL Process Definition
Edited using ActiveBPEL(tm) Designer Version 2.0.0 (http://www.active-endpoints.com)
-->
<process name="RProteomics" suppressJoinFailure="yes" targetNamespace="http://RProteomics" xmlns="http://schemas.xmlsoap.org/ws/2003/03/business-process/" xmlns:bpws="http://schemas.xmlsoap.org/ws/2003/03/business-process/" xmlns:ns1="http://cabig.nic.nih.gov/bpel" xmlns:ns2="http://www.globus.org/namespaces/cagrid/RProteomics/RProteomics" xmlns:ns3="gme://RProteomics.caBIG/5/edu.duke.cabig.rproteomics.domain.serviceInterface" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:t="d">
   <partnerLinks>
      <partnerLink myRole="service" name="RproteomicsPartnerLinkType" partnerLinkType="ns1:RproteomicsPartnerLinkType" partnerRole="service"/>
      <partnerLink myRole="client" name="RproteomicsClientPartnerLinkType" partnerLinkType="ns1:RproteomicsClientPartnerLinkType"/>
   </partnerLinks>
   <variables>
      <variable messageType="ns2:echoInputMessage" name="callEchoInputMessage"/>
      <variable messageType="ns2:echoOutputMessage" name="callEchoOutputMessage"/>
      <variable messageType="ns2:echoInputMessage" name="echoInputMessage"/>
      <variable messageType="ns2:echoOutputMessage" name="echoOutputMessage"/>
      <variable messageType="ns2:general_interpolateInputMessage" name="general_interpolateInputMessage"/>
      <variable messageType="ns2:general_interpolateOutputMessage" name="general_interpolateOutputMessage"/>
      <variable messageType="ns2:removeBackground_runningQuantileInputMessage" name="removeBackground_runningQuantileInputMessage"/>
      <variable messageType="ns2:removeBackground_runningQuantileOutputMessage" name="removeBackground_runningQuantileOutputMessage"/>
 <variable name="indexCounter" type="xsd:integer"/>
<variable name="count" type="xsd:integer"/>

   </variables>

   <sequence>
      <receive createInstance="yes" operation="invokeEcho" partnerLink="RproteomicsClientPartnerLinkType" portType="ns1:invokeRproteomicsPortType" variable="callEchoInputMessage"/>
      <assign>

         <copy>
            <from expression="&quot;1&quot;"/>
            <to variable="indexCounter"/>
         </copy>


<!--
<copy>
         <from>
<ns2:removeBackground_runningQuantile xmlns="">
<lsids><value>urn:lsid:rproteomics.cabig.duhs.duke.edu:scanfeatures:9d694d22-f049-43ac-b3dd-c94f1df544c4</value></lsids>
<lsids><value>urn:lsid:rproteomics.cabig.duhs.duke.edu:scanfeatures:9d694d22-f049-43ac-b3dd-c94f1df544c4</value></lsids>
<windowSize><size>1023</size></windowSize>
<percentile><value>75</value></percentile>
</ns2:removeBackground_runningQuantile>
</from>
         <to part="parameters"  variable="removeBackground_runningQuantileInputMessage"/>
</copy>
-->

         <copy>
            <from part="parameters" variable="callEchoInputMessage"/>
            <to part="parameters" variable="echoInputMessage"/>
         </copy>
      </assign>


      <invoke inputVariable="echoInputMessage" operation="echo" outputVariable="echoOutputMessage" partnerLink="RproteomicsPartnerLinkType" portType="ns2:RProteomicsPortType"/>
      <assign>
         <copy>
            <from part="parameters" variable="echoOutputMessage"/>
            <to part="parameters" variable="callEchoOutputMessage"/>
         </copy>
      </assign>
      <assign>
         <copy>
            <from part="parameters" variable="callEchoInputMessage"/>
            <to part="parameters" variable="general_interpolateInputMessage"/>
         </copy>
      </assign>

      <invoke inputVariable="general_interpolateInputMessage" operation="general_interpolate" outputVariable="general_interpolateOutputMessage" partnerLink="RproteomicsPartnerLinkType" portType="ns2:RProteomicsPortType"/>

      <assign>
         <copy>
            <from part="parameters" variable="general_interpolateOutputMessage"/>
            <to part="parameters" variable="callEchoOutputMessage"/>
         </copy>
      </assign>

      <assign>
         <copy>
            <from expression="count(bpws:getVariableData('callEchoOutputMessage',  'parameters', '/ns2:echoResponse')/response)"/>
            <to variable="count"/>
         </copy>
      </assign>


      <while condition="bpws:getVariableData('indexCounter') &lt;= bpws:getVariableData('count')">
         <flow>
             <assign>
	      <copy>
                 <from expression="bpws:getVariableData('callEchoOutputMessage',  'parameters', '/ns2:echoResponse')/response[bpws:getVariableData('indexCounter')]"/>
                 <to part="parameters" variable="removeBackground_runningQuantileInputMessage" query="/ns2:removeBackground_runningQuantile/lsids[bpws:getVariableData('indexCounter')]"/>
              </copy>

              <copy>
                  <from expression="bpws:getVariableData('indexCounter') + 1"/>
                  <to variable="indexCounter"/>
               </copy>

             </assign>
         </flow>
      </while>

      <assign> 
         <copy>
            <from expression="'1023'"/>
            <to part="parameters" query="/ns2:removeBackground_runningQuantile/windowSize/size" variable="removeBackground_runningQuantileInputMessage"/>
         </copy>
         <copy>
            <from expression="'75'"/>
            <to part="parameters" query="/ns2:removeBackground_runningQuantile/percentile/value" variable="removeBackground_runningQuantileInputMessage"/>
         </copy>
      </assign>


      <invoke inputVariable="removeBackground_runningQuantileInputMessage" operation="removeBackground_runningQuantile" outputVariable="removeBackground_runningQuantileOutputMessage" partnerLink="RproteomicsPartnerLinkType" portType="ns2:RProteomicsPortType"/>
      <assign>
         <copy>
            <from part="parameters" variable="removeBackground_runningQuantileOutputMessage"/>
            <to part="parameters" variable="callEchoOutputMessage"/>
         </copy>
      </assign>


      <reply operation="invokeEcho" partnerLink="RproteomicsClientPartnerLinkType" portType="ns1:invokeRproteomicsPortType" variable="callEchoOutputMessage"/>
   </sequence>
</process>
