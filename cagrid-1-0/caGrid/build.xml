<?xml version="1.0"?>

<!-- ================================================================= -->
<!-- caGrid Master build file                                          -->
<!-- ================================================================= -->

<project name="Master" default="all" basedir=".">
	<!-- Give user the chance to override properties -->
	<property environment="env" />
	<property file="build.properties" />

	<!-- Layout info -->
	<property name="projects.dir" location="${basedir}/projects" />
	<property name="test.dir" location="${basedir}/test" />

	<!-- IMPORT THE UTILITIES TARGETS -->
	<import file="antfiles/ant-utilities.xml" />
	<import file="antfiles/test-utilities.xml" />

	<!-- IMPORT THE TEST TARGET -->
	<import file="${test.dir}/test.xml" />

	<!-- =============================================================== -->
	<!-- You can do your "prepare" outside of targets in ant now, so do that here-->
	<!-- =============================================================== -->
	<tstamp />


	<!-- =============================================================== -->
	<!-- Define the build artifacts (created/used by projects) here      -->
	<!--                                                                 -->
	<!-- NOTE:  These should be all of the files necessary to "depend" on-->
	<!-- the project (not just the built files).  Make a separate        -->
	<!-- artifact for groups of files that will probably be copied to    -->
	<!-- separate directoris (e.g. jars and conf files)                  -->
	<!-- =============================================================== -->
	<fileset dir="${projects.dir}/core/build/jars" id="artifact.core.main.jars">
		<include name="*.jar" />
		<exclude name="*test*.jar" />
	</fileset>
	<fileset dir="${projects.dir}/core/build/jars" id="artifact.core.test.jars">
		<include name="*test*.jar" />
	</fileset>
	<fileset dir="${projects.dir}/metadata/build/lib" id="artifact.metadata.main.jars">
		<include name="*.jar" />
		<exclude name="*test*.jar" />
	</fileset>


	<!-- =============================================================== -->
	<!-- CORE: This cannot have any dependencies on other projects       -->
	<!-- =============================================================== -->
	<target name="build-core" description="Builds the core">
		<ant dir="${projects.dir}/core" inheritAll="false" antfile="build.xml" target="all" />
	</target>


	<!-- =============================================================== -->
	<!-- METADATA: This may only depend on core                          -->
	<!-- =============================================================== -->
	<target name="build-metadata" depends="build-core" description="Builds the common metadata">
		<!-- copy dependent artifacts into current target's lib dir -->
		<copy todir="${projects.dir}/metadata/lib">
			<fileset refid="artifact.core.main.jars" />
		</copy>
		<ant dir="${projects.dir}/metadata" inheritAll="false" antfile="build.xml" target="jar" />
	</target>


	<!-- =============================================================== -->
	<!-- INTRODUCE:                                                      -->
	<!-- =============================================================== -->
	<target name="build-introduce" depends="build-core, build-metadata" description="Builds Introduce">
		<!-- copy dependent artifacts into current target's lib dir -->
		<copy todir="${projects.dir}/introduce/lib">
			<fileset refid="artifact.metadata.main.jars" />
		</copy>
		<ant dir="${projects.dir}/introduce" inheritAll="false" antfile="build.xml" target="all" />
	</target>


	<!-- ============================================================== -->
	<!-- Cleans up generated stuff                                      -->
	<!-- ============================================================== -->
	<target name="clean" description="Cleans all projects.">
		<!--<subant target="clean"  >
			<fileset dir="${projects.dir}" includes="*/build.xml" />
		</subant>-->
		<ant dir="${projects.dir}/core" inheritAll="false" antfile="build.xml" target="clean" />
		<ant dir="${projects.dir}/metadata" inheritAll="false" antfile="build.xml" target="clean" />
		<ant dir="${projects.dir}/introduce" inheritAll="false" antfile="build.xml" target="clean" />
	</target>


	<!-- ============================================================== -->
	<!-- Builds from scratch                                            -->
	<!-- ============================================================== -->
	<target name="all" description="Builds the entire application" depends="clean, build-core, build-metadata, build-introduce" />
</project>

