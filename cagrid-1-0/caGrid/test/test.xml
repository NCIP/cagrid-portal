<!-- ======================================================================= -->
<!-- caGrid Utilities build file                                             -->
<!-- ======================================================================= -->
<project name="caGrid_tests_harness" basedir=".">
    <import file="test-dart.xml" />

    <property name="test.logs.dir" value="${test.dir}/logs" />
    <property name="junit.results.dir" value="${test.logs.dir}/junit" />

    <!-- The presence of this property causes the build to fail as soon as test fails. -->
    <!-- <property name="test.failfast" value="true" /> -->
    <!-- The presence of this property causes unit tests to be run during test target. -->
    <property name="run.unit.tests" value="true" />
    <!-- The presence of this property causes system tests to be run during test target. -->
    <property name="run.system.tests" value="true" />
    <!-- The presence of this property causes an html test report to be created. -->
    <property name="create.test.report" value="true" />

    <!-- ============================================================================ -->
    <!-- Calls unit and system test for each project and aggregates the log resutls   -->
    <!-- ============================================================================ -->
    <target name="test" depends="prepare,createDartTestFiles" description="Test all the projects.">
        <!-- Clean out old logs first -->
        <delete failonerror="false">
            <fileset dir="${junit.results.dir}">
                <include name="*" />
            </fileset>
        </delete>

        <!-- Call Unit Tests -->
        <if>
            <equals arg1="${run.unit.tests}" arg2="true" />
            <then>
                <trycatch property="test.failed.message">
                    <try>
                        <runtarget target="unit-test" />
                    </try>
                    <catch>
                        <property name="test.failed" value="true" />
                    </catch>
                </trycatch>
            </then>
            <else>
                <echo message="Skipping unit tests." />
            </else>
        </if>


        <!-- Call System Tests -->
        <if>
            <equals arg1="${run.system.tests}" arg2="true" />
            <then>
                <trycatch property="test.failed.message">
                    <try>
                        <runtarget target="system-test" />
                    </try>
                    <catch>
                        <property name="test.failed" value="true" />
                    </catch>
                </trycatch>
            </then>
            <else>
                <echo message="Skipping system tests." />
            </else>
        </if>


        <!-- Try to create a report -->
        <if>
            <equals arg1="${create.test.report}" arg2="true" />
            <then>
                <trycatch property="test.report.failed.message">
                    <try>
                        <mkdir dir="${junit.results.dir}/report" />
                        <junitreport todir="${junit.results.dir}">
                            <fileset dir="${junit.results.dir}">
                                <include name="TEST-*.xml" />
                            </fileset>
                            <report format="frames" todir="${junit.results.dir}/report" />
                        </junitreport>
                        <echo message="Created test report in ${junit.results.dir}/report" />
                    </try>
                    <catch>
                        <echo message="Test Report creation failed (${test.report.failed.message})!" />
                    </catch>
                </trycatch>
            </then>
            <else>
                <echo message="Skipping test report creation." />
            </else>
        </if>

        <fail message="Tests failed! ${test.failed.message} Consult the logs for details." if="test.failed" />
    </target>

    <!-- not to be called directly -->
    <target name="unit-test">
        <for list="${unit.testable.projects.list}" parallel="true" param="project.name" trim="true">
            <sequential>
                <echo message="Unit testing project @{project.name}." />
                <trycatch property="@{project.name}.unit.test.failed.message">
                    <try>
                        <ant inheritall="false" dir="projects/@{project.name}" antfile="build.xml" target="test">
                            <property name="junit.results.dir" value="${junit.results.dir}" />
                        </ant>
                    </try>
                    <catch>
                        <fail message="@{project.name} Unit tests failed (${@{project.name}.unit.test.failed.message})" if="test.failfast" />
                        <echo message="@{project.name} Unit tests failed (${@{project.name}.unit.test.failed.message}), proceeding with other tests, but build will fail at completion." />
                        <property name="unit.test.failed" value="true" />
                    </catch>
                </trycatch>
            </sequential>
        </for>

        <fail message="Unit Tests failed! Consult the logs for details." if="unit.test.failed" />
    </target>

    <!-- not to be called directly -->
    <target name="system-test">
        <for list="${system.testable.projects.list}" parallel="true" param="project.name" trim="true">
            <sequential>
                <echo message="System Testing project @{project.name}." />
                <trycatch property="@{project.name}.system.test.failed.message">
                    <try>
                        <ant inheritall="false" dir="projects/@{project.name}" antfile="build.xml" target="systemTest">
                            <property name="junit.results.dir" value="${junit.results.dir}" />
                        </ant>
                    </try>
                    <catch>
                        <fail message="@{project.name} System tests failed (${@{project.name}.system.test.failed.message})" if="test.failfast" />
                        <echo message="@{project.name} System tests failed (${@{project.name}.system.test.failed.message}), proceeding with other tests, but build will fail at completion." />
                        <property name="test.failed" value="true" />
                    </catch>
                </trycatch>
            </sequential>
        </for>

        <fail message="System Tests failed! Consult the logs for details." if="system.test.failed" />
    </target>
</project>