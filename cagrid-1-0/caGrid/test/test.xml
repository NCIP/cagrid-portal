<!-- ======================================================================= -->
<!-- caGrid Utilities build file                                             -->
<!-- ======================================================================= -->
<project name="caGrid_tests_harness" basedir=".">

    <property name="junit.results.dir" value="${test.logs.dir}/junit" />
    <property name="test.lib.dir" value="${test.dir}/lib" />

    <!-- Get the HOSTNAME in an os independant way -->
    <property name="env.HOSTNAME" value="${env.COMPUTERNAME}" />

    <!-- For your dart client -->
    <property name="dart.buildname"
              value="${os.name}-${os.arch}-${os.version}-JDK-${java.version}" />
    <property name="dart.site" value="${env.HOSTNAME}" />

    <!-- For the dart server-->
    <property name="dart.port" value="8081" />
    <property name="dart.project" value="caGrid-1.0" />
    <property name="dart.server" value="malibu.bmi.ohio-state.edu" />


    <!-- =============================================================== -->
    <!-- The Dart Classpath                                              -->
    <!-- =============================================================== -->
    <path id="dart.classpath">
        <fileset dir="${test.lib.dir}">
            <include name="DartClient-0.6.jar" />
        </fileset>
    </path>


    <!-- =============================================================== -->
    <!-- Configure dart                                                  -->
    <!-- =============================================================== -->
    <target name="createDartTestFiles">
        <!-- Create the BuildName info, if necessary -->
        <filter token="Dart.BuildName" value="${dart.buildname}" />
        <filter token="Dart.Site" value="${dart.site}" />

        <filter token="Dart.Track" value="Continuous" />
        <copy file="${test.dir}/BuildNameTemplate.xml"
              tofile="${test.logs.dir}/BuildNameContinuous.xml"
              filtering="true" />

        <filter token="Dart.Track" value="Nightly" />
        <copy file="${test.dir}/BuildNameTemplate.xml"
              tofile="${test.logs.dir}/BuildNameNightly.xml"
              filtering="true" />
    </target>
    
    
    <!-- =============================================================== -->
    <!-- Call test for each project and aggregates the log resutls       -->
    <!-- =============================================================== -->
    <target name="test" depends="createDartTestFiles">
        <sequential>
            <ant inheritall="false" dir="projects/core" antfile="build.xml" target="test">
                <property name="junit.results.dir" value="${junit.results.dir}" />
            </ant>
            <ant inheritall="false" dir="projects/introduce" antfile="build.xml" target="test">
                <property name="junit.results.dir" value="${junit.results.dir}" />
            </ant>
        </sequential>
    </target>
    
    
    <!-- =============================================================== -->
    <!-- Set the proxy, and publish the results to dart                  -->
    <!-- =============================================================== -->
    <target name="setproxy1" if="env.HTTP_PROXY_PORT">
        <property name="proxyhost" value="${env.HTTP_PROXY}" />
        <property name="proxyport" value="${env.HTTP_PROXY_PORT}" />
        <echo>Set proxy1: proxyhost=${proxyhost} proxyport=${proxyport}</echo>
        <setproxy proxyhost="${proxyhost}" proxyport="${proxyport}" />
    </target>
    <target name="setproxy2" if="proxyport">
        <echo>Set proxy2: proxyhost=${proxyhost} proxyport=${proxyport}</echo>
        <setproxy proxyhost="${proxyhost}" proxyport="${proxyport}" />
    </target>
    <target name="publish"
            depends="setproxy1, setproxy2"
            description="Call to publish test results to dart, doesn't do any building or testing.">
        <fail unless="dart.logfile"
              message="Before you attempt to publish to dart, you must set the property [dart.logfile] to the location of the log to be sent to dart." />
        <java classname="dart.DartClient" failonerror="true">
            <classpath refid="dart.classpath" />
            <arg value="--server" />
            <arg value="${dart.server}" />
            <arg value="--port" />
            <arg value="${dart.port}" />
            <arg value="${dart.project}" />
            <arg value="${dart.logfile}" />
        </java>
    </target>

    <!-- ONLY to be called from cruise control's antpublisher (it passes some properties) -->
    <target name="ccpublish">
        <property name="dart.logfile" value="${logdir}/${logfile}"/>
        <ant target="publish"/>
    </target>
</project>
