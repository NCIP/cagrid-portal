<!-- ============================================================= -->
<!-- This is an example ant script for deploying a set of services -->
<!-- to a globus container.                                        -->
<!-- You should edit cagrid.dir and cagrid.tests.dir to point to   -->
<!-- your checkout of caGrid.  Then, edit globus.nonsecure and     -->
<!-- globus.secure to point to where your globus containers will   -->
<!-- live.  This is separate from your ws-core installation so     -->
<!-- that it stays "fresh".                                        -->
<!-- Also, remove the calls to netsvc if you are not using Windows -->
<!-- NT services                                                   -->
<!-- ============================================================= -->
<project name="deploy-core" default="all" basedir=".">
	<property environment="env" />

	<!-- ============================================================= -->
	<!-- Edit these properties                                         -->
	<!-- ============================================================= -->
	
	<!-- point this to your checkout of the caGrid codebase -->
	<property name="cagrid.dir" location="C:\caBIG\cagrid-1-0\caGrid"/>

	<!-- point this to your checkout of the caGrid tests codebase -->
	<property name="cagrid.tests.dir" location="C:\caBIG\cagrid-1-0\tests"/>

	<!-- point this to where you want your non-secure globus to live (usually not GLOBUS_LOCATION) -->
	<property name="globus.nonsecure" location="c:/ws-core-4.0.2-8080"/>

	<!-- point this to where you want your secure globus to live (usually not GLOBUS_LOCATION) -->
	<property name="globus.secure" location="c:/ws-core-4.0.2-8080"/>

	<macrodef name="createGlobus">
		<attribute name="new.globus" />

		<sequential>
			<echo>Recreating globus container at @{new.globus}</echo>
			<delete dir="@{new.globus}"/>
			<mkdir dir="@{new.globus}"/>
			<copy todir="@{new.globus}">
				<fileset dir="${env.GLOBUS_LOCATION}">
					<include name="**/*"/>
				</fileset>
			</copy>
		</sequential>
	</macrodef>

	<macrodef name="deployCore">
		<attribute name="new.globus" />

		<sequential>
			<echo>Deploying cadsr to @{new.globus}</echo>
			<ant dir="${cagrid.dir}/projects/cadsr" target="deployGlobus">
				<property name="env.GLOBUS_LOCATION" value="@{new.globus}"/>
			</ant>

			<echo>Deploying gme to @{new.globus}</echo>
			<ant dir="${cagrid.dir}/projects/gme" target="deployGlobus">
				<property name="env.GLOBUS_LOCATION" value="@{new.globus}"/>
			</ant>

			<echo>Deploying index to @{new.globus}</echo>
			<ant dir="${cagrid.dir}/projects/index" target="deployIndexGlobus">
				<property name="env.GLOBUS_LOCATION" value="@{new.globus}"/>
			</ant>

			<echo>Deploying wms SampleService1 to @{new.globus}</echo>
			<ant dir="${cagrid.tests.dir}/projects/workflow-services/SampleService1" target="deployGlobus">
				<property name="env.GLOBUS_LOCATION" value="@{new.globus}"/>
			</ant>

			<echo>Deploying wms SampleService2 to @{new.globus}</echo>
			<ant dir="${cagrid.tests.dir}/projects/workflow-services/SampleService2" target="deployGlobus">
				<property name="env.GLOBUS_LOCATION" value="@{new.globus}"/>
			</ant>
		</sequential>
	</macrodef>

	<macrodef name="deploySecure">
		<attribute name="new.globus" />

		<sequential>
			<mkdir dir="@{new.globus}/tmp"/>
			<exec executable="@{new.globus}/bin/grid-proxy-init.bat" dir="@{new.glous}">
				<arg value="-hours"/>
				<arg value="100000"/>
				<arg value="-cert"/>
				<arg value="@{new.globus}/grid-security/cagrid2.duhs.duke.edu-cert.pem"/>
				<arg value="-key"/>
				<arg value="@{new.globus}/grid-security/cagrid2.duhs.duke.edu-key.pem"/>
				<arg value="-out"/>
				<arg value="@{new.globus}/tmp/x509up_u1247"/>
			</exec>
			<mkdir dir="@{new.globus}/autonfs/home/madduri"/>
			<touch file="@{new.globus}/autonfs/home/madduri/gridmap"/>

			<echo>Deploying dorian to @{new.globus}</echo>
			<ant dir="${cagrid.dir}/projects/dorian" target="deployGlobus">
				<property name="env.GLOBUS_LOCATION" value="@{new.globus}"/>
			</ant>

			<echo>Deploying gts to @{new.globus}</echo>
			<ant dir="${cagrid.dir}/projects/gts" target="deployGlobus">
				<property name="env.GLOBUS_LOCATION" value="@{new.globus}"/>
			</ant>

			<echo>Deploying syncgts to @{new.globus}</echo>
			<ant dir="${cagrid.dir}/projects/syncgts" target="deployGlobus">
				<property name="env.GLOBUS_LOCATION" value="@{new.globus}"/>
			</ant>

			<echo>Deploying wms to @{new.globus}</echo>
			<ant dir="${cagrid.dir}/projects/workflow/WorkflowManagementService" target="deployGlobus">
				<property name="env.GLOBUS_LOCATION" value="@{new.globus}"/>
			</ant>

			<echo>Deploying wms SecureSample to @{new.globus}</echo>
			<ant dir="${cagrid.tests.dir}/projects/workflow-services/SecureSample" target="deployGlobus">
				<property name="env.GLOBUS_LOCATION" value="@{new.globus}"/>
			</ant>
		</sequential>
	</macrodef>

	<macrodef name="netsvc">
		<attribute name="action" />
		<attribute name="service" />

		<sequential>
			<exec executable="net">
				<arg line="@{action} @{service}"/>
			</exec>
		</sequential>
	</macrodef>

	<target name="update">
		<echo>Updating caGrid</echo>
		<cvs dest="${cagrid.dir}" command="update"/>
		<echo>Updating caGrid tests</echo>
		<cvs dest="${cagrid.tests.dir}" command="update"/>
	</target>

	<target name="build">
		<echo>Building caGrid</echo>
		<ant dir="${cagrid.dir}" target="all"/>
		<echo>Building caGrid tests</echo>
		<ant dir="${cagrid.tests.dir}" target="all"/>
	</target>

	<!-- ============================================================= -->
	<!-- Modify the calls here if you want                             -->
	<!-- ============================================================= -->

	<target name="all" depends="update,build">
		<netsvc action="stop" service="Globus-8080"/>
		<createGlobus new.globus="c:/ws-core-4.0.2-8080"/>
		<deployCore new.globus="c:/ws-core-4.0.2-8080"/>
		<netsvc action="start" service="Globus-8080"/>

		<netsvc action="stop" service="Globus-8443"/>
		<createGlobus new.globus="c:/ws-core-4.0.2-8443"/>
		<deployCore new.globus="c:/ws-core-4.0.2-8443"/>
		<deploySecure new.globus="c:/ws-core-4.0.2-8443"/>
		<netsvc action="start" service="Globus-8443"/>
	</target>
</project>