<project>

    <property name="aggr.dir" value="aggr"/>
    <property name="aggr.lib.dir" value="${aggr.dir}/lib"/>
    <property name="aggr.build.dir" value="${aggr.dir}/build"/>
    <property name="aggr.classes.dir" value="${aggr.build.dir}/classes"/>
    <property name="aggr.src.java.dir" value="${aggr.dir}/src/java"/>

    <property name="aggr.test.dir" value="aggr/test"/>
    <property name="aggr.test.lib.dir" value="${aggr.test.dir}/lib"/>
    <property name="aggr.test.build.dir" value="${aggr.test.dir}/build"/>
    <property name="aggr.test.classes.dir"
              value="${aggr.test.build.dir}/classes"/>
    <property name="aggr.test.src.java.dir"
              value="${aggr.test.dir}/src/java"/>

    <property name="aggr.build.reports.dir" value="${aggr.build.dir}/reports"/>

    <property name="aggr.debug" value="true"/>

    <path id="aggr.compile.cp">
        <path refid="db.compile.cp"/>
        <pathelement location="${db.classes.dir}"/>
        <fileset dir="${db.lib.dir}">
            <include name="hibernate/search/*.jar"/>
        </fileset>
        <fileset dir="${aggr.lib.dir}">
            <!-- TODO: sort this out a bit more -->
            <include name="**/*.jar"/>
        </fileset>
        <fileset dir="${aggr.lib.dir}/globus">
            <include name="*.jar"/>
        </fileset>
         <fileset dir="${aggr.lib.dir}/mail">
            <include name="*.jar"/>
        </fileset>
    </path>

    <path id="aggr.test.compile.cp">
        <path refid="aggr.compile.cp"/>
        <path refid="db.test.compile.cp"/>
        <pathelement location="${aggr.classes.dir}"/>
        <pathelement location="${db.test.classes.dir}"/>
    </path>

    <path id="aggr.run.cp">
        <pathelement location="db/test"/>
        <pathelement location="${aggr.classes.dir}"/>
        <path refid="db.run.cp"/>
        <path refid="aggr.compile.cp"/>
        <pathelement location="portlets/test/lib/acegi-security-1.0.3.jar"/>
        <pathelement location="portlets/src/war/WEB-INF/classes"/>
    </path>

    <path id="aggr.test.run.cp">
        <path refid="db.test.run.cp"/>
        <path refid="aggr.run.cp"/>
        <path refid="aggr.test.compile.cp"/>
        <pathelement location="${aggr.test.classes.dir}"/>
        <pathelement location="${aggr.test.dir}"/>
    </path>

    <target name="aggr:compile" depends="db:compile">
        <mkdir dir="${aggr.classes.dir}"/>
        <javac srcdir="${aggr.src.java.dir}" destdir="${aggr.classes.dir}"
               debug="${aggr.debug}">
            <classpath refid="aggr.compile.cp"/>
        </javac>
    </target>

    <target name="aggr:compile-test" depends="aggr:compile, db:compile-test">
        <mkdir dir="${aggr.test.classes.dir}"/>
        <javac srcdir="${aggr.test.src.java.dir}" destdir="${aggr.test.classes.dir}"
               debug="true">
            <classpath refid="aggr.test.compile.cp"/>
        </javac>
    </target>


    <target name="aggr:prepare-test-cp"
            depends="aggr:prepare-run-cp,aggr:compile-test">

        <copy todir="${aggr.test.classes.dir}" overwrite="true">
            <fileset dir="${db.dir}/etc">
                <include name="*.properties"/>
                <include name="*.xml"/>
                <include name="*.wsdd"/>
            </fileset>
        </copy>


    </target>

    <target name="aggr:prepare-run-cp"
            depends="aggr:compile">

        <copy todir="${aggr.classes.dir}" overwrite="true">
            <fileset dir="${db.dir}/etc">
                <include name="*.properties"/>
                <include name="*.xml"/>
            </fileset>
            <fileset dir="${aggr.dir}/etc">
                <include name="*.properties"/>
                <include name="*.xml"/>
                <include name="*.wsdd"/>
                <include name="*.dtd"/>
                <exclude name="*.sync-description.xml"/>
            </fileset>
        </copy>

        <antcall target="create-cagridportal-properties">
            <param name="target.dir" value="${aggr.classes.dir}/cagridportal.properties"/>
        </antcall>

        <copy file="${aggr.trust.syncgts.file}"
              tofile="${aggr.classes.dir}/sync-description.xml"
              overwrite="true"/>

    </target>

    <target name="aggr:test" depends="aggr:prepare-test-cp">

        <mkdir dir="${aggr.test.build.dir}/junit-reports"/>
        <junit printsummary="yes" showoutput="true" fork="true">

            <classpath refid="aggr.test.run.cp"/>

            <formatter type="xml"/>

            <batchtest todir="${aggr.test.build.dir}/junit-reports">
                <fileset dir="${aggr.test.src.java.dir}">
                    <include name="**/*Test.java"/>
                    <exclude name="**/Abstract*.java"/>
                    <exclude name="**/*SystemTest.java"/>
                </fileset>
            </batchtest>

        </junit>
    </target>

    <target name="aggr:clean">
        <delete dir="${aggr.build.dir}"/>
        <delete dir="${aggr.test.build.dir}"/>
    </target>

    <target name="aggr:run-regsvc" depends="aggr:prepare-run-cp">
        <java classname="gov.nih.nci.cagrid.portal.util.RunRegSvc" classpathref="aggr.run.cp" fork="true"/>
    </target>

    <target name="aggr:run-regsvcman" depends="aggr:prepare-run-cp">
        <java classname="gov.nih.nci.cagrid.portal.util.RegisterService" classpathref="aggr.run.cp" fork="true">
            <arg value="http://cagrid-index.nci.nih.gov:8080/wsrf/services/DefaultIndexService"/>
            <arg value="http://141.161.25.20:8080/wsrf/services/cagrid/GridPIR"/>
        </java>
    </target>

    <target name="aggr:run-inquire-status" depends="aggr:prepare-run-cp">
        <input message="Enter Grid Service URL:" addproperty="aggr:serviceURL"/>
        <input message="Enter Index Service URL:" addproperty="aggr:idxServiceURL"/>

        <java classname="gov.nih.nci.cagrid.portal.util.ServiceStatusInfo" classpathref="aggr.run.cp" fork="true">
            <arg value="${aggr:serviceURL}"/>
            <arg value="${aggr:idxServiceURL}"/>
        </java>
    </target>

    <target name="aggr:run-metachange" depends="aggr:prepare-run-cp">
        <java classname="gov.nih.nci.cagrid.portal.util.RunMetaChange" classpathref="aggr.run.cp" fork="true"/>
    </target>

    <target name="aggr:run-status" depends="aggr:prepare-run-cp">
        <java classname="gov.nih.nci.cagrid.portal.util.RunStatusChange" classpathref="aggr.run.cp" fork="true"/>
    </target>

    <target name="aggr:run-trust" depends="aggr:prepare-run-cp">
        <java classname="gov.nih.nci.cagrid.portal.util.RunTrust" classpathref="aggr.run.cp" fork="true"/>
    </target>

    <target name="aggr:run-geocode" depends="aggr:prepare-run-cp">
        <java classname="gov.nih.nci.cagrid.portal.util.RunGeocode" classpathref="aggr.run.cp" fork="true"/>
    </target>

    <target name="aggr:run-xmlschemas" depends="aggr:prepare-run-cp">
        <java classname="gov.nih.nci.cagrid.portal.util.RunXmlSchemas" classpathref="aggr.run.cp" fork="true"/>
    </target>

    <target name="aggr:run-concepts" depends="aggr:prepare-run-cp">
        <java classname="gov.nih.nci.cagrid.portal.util.RunConcepts" classpathref="aggr.run.cp" fork="true"/>
    </target>

    <target name="aggr:kill-svc-meta" depends="aggr:prepare-run-cp">
        <java classname="gov.nih.nci.cagrid.portal.util.KillServiceMetadata" classpathref="aggr.run.cp"/>
    </target>

    <target name="aggr:kill-grid-svcs" depends="aggr:prepare-run-cp">
        <java classname="gov.nih.nci.cagrid.portal.util.KillGridServices" classpathref="aggr.run.cp"/>
    </target>

    <target name="aggr:report-banned-svcs" depends="aggr:prepare-run-cp"
            description="Get a list of Banned services">
        <java classname="gov.nih.nci.cagrid.portal.util.ReportBannedServices" classpathref="aggr.run.cp"/>
    </target>

    <target name="aggr:load-workspaces" depends="aggr:prepare-run-cp">
        <input message="Enter Path for participant list (.xls file):" addproperty="aggr:participant-list"
               defaultvalue="${aggr.dir}/etc/caBIG_Workspaces_participants.xls"/>

        <java classname="gov.nih.nci.cagrid.portal.util.WorkspacesLoader" classpathref="aggr.run.cp" fork="true">
            <arg value="${aggr:participant-list}"/>
        </java>
    </target>

    <target name="aggr:report:svcs-with-status" depends="aggr:prepare-run-cp" description="Will report all services with the given status">
           <input message="Enter Service Status to report on:" validargs="DORMANT,BANNED,ACTIVE,INACTIVE"
                  defaultvalue="DORMANT" addproperty="status"/>
           <java classname="gov.nih.nci.cagrid.portal.util.ReportServicesWithStatus" classpathref="aggr.run.cp">
               <arg value="${status}"/>
           </java>
       </target>


    <target name="report:dormant-inactive-svcs" depends="aggr:prepare-run-cp"
            description="Will generate an excel report in the build/reports directory for all services with DORMANT and INACTIVE status">
        <mkdir dir="${aggr.build.reports.dir}"/>

        <property name="report.service.statuses" value="DORMANT,INACTIVE"/>
        <property name="report.filename" value="Portal_Servcie_Status_Report.xls"/>
        <property name="report.emails" value=""/>

        <java fork="true" dir="${aggr.build.reports.dir}"
              classname="gov.nih.nci.cagrid.portal.util.ServiceStatusReportGenerator" classpathref="aggr.run.cp">
            <arg value="-status"/>
            <arg value="${report.service.statuses}"/>
            <arg value="-filename"/>
            <arg value="${report.filename}"/>
            <arg value="-email"/>
            <arg value="${report.emails}"/>
        </java>
    </target>

    <target name="aggr:ban-mgr" depends="aggr:prepare-run-cp">
        <input message="Enter operation:" validargs="ban,unban" addproperty="aggr:banOp"/>
        <input message="Enter service URL:" addproperty="aggr:banOpUrl"/>
        <java classname="gov.nih.nci.cagrid.portal.util.ServiceBanManager" classpathref="aggr.run.cp">
            <arg value="${aggr:banOp}"/>
            <arg value="${aggr:banOpUrl}"/>
        </java>
    </target>


    <target name="aggr:delete-user" depends="aggr:prepare-run-cp">
        <input message="Enter Grid Identitity of User:" addproperty="aggr:userGridIdentity"/>

        <java classname="gov.nih.nci.cagrid.portal.util.DeleteUserUtil" classpathref="aggr.run.cp" fork="true">
            <arg value="${aggr:userGridIdentity}"/>
        </java>

    </target>

</project>