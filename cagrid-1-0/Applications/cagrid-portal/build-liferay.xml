<project>

	<property name="liferay.dir" value="portals/liferay" />
	<property name="liferay.lib.dir" value="${liferay.dir}/lib" />
	<property name="liferay.build.dir" value="${liferay.dir}/build" />
	<property name="liferay.classes.dir" value="${liferay.build.dir}/classes" />
	<property name="liferay.src.java.dir" value="${liferay.dir}/src/java" />
	<property name="liferay.src.war.dir" value="${liferay.dir}/src/war" />
	<property name="liferay.src.layouts.dir" value="${liferay.dir}/src/layouts" />
	<property name="liferay.src.themes.dir" value="${liferay.dir}/src/themes" />
	<property name="liferay.src.scripts.dir" value="${liferay.dir}/src/scripts" />

	<property name="liferay.test.dir" value="${liferay.dir}/test" />
	<property name="liferay.test.lib.dir" value="${liferay.test.dir}/lib" />
	<property name="liferay.test.build.dir" value="${liferay.test.dir}/build" />
	<property name="liferay.test.classes.dir"
		value="${liferay.test.build.dir}/classes" />
	<property name="liferay.test.src.java.dir"
		value="${liferay.test.dir}/src/java" />
		
	<property name="liferay.jboss.download.url" value="http://switch.dl.sourceforge.net/sourceforge/jboss/jboss-4.0.5.GA.zip"/>
	<property name="liferay.jboss.dir.name" value="jboss-4.0.5.GA"/>
	<property name="liferay.jboss.zip" value="${liferay.jboss.dir}/jboss-4.0.5.GA.zip"/>
	<property name="liferay.jboss.home" value="${liferay.jboss.dir}/${liferay.jboss.dir.name}"/>
	<property name="liferay.jboss.deploy.dest.dir" value="${liferay.jboss.home}/server/${liferay.jboss.server.name}/deploy"/>
	<property name="liferay.root.context.dir" value="${liferay.jboss.home}/server/${liferay.jboss.server.name}/deploy/liferay-portal.war"/>
	<property name="liferay.db.url" value="jdbc:mysql://${liferay.db.host}:${liferay.db.port}/${liferay.db.name}" />
	<property name="liferay.db.driver" value="com.mysql.jdbc.Driver" />
	<property name="liferay.db.driver.path" value="${basedir}/${db.jdbc.driver.jar}" />
	<property name="liferay.downloads.dir" value="${liferay.jboss.dir}"/>
	<property name="liferay.dependencies.download.url" value="http://downloads.sourceforge.net/lportal/liferay-portal-dependencies-4.3.3.zip"/>
	<property name="liferay.dependencies.zip" value="liferay-portal-dependencies-4.3.3.zip"/>
	<property name="liferay.war.download.url" value="http://downloads.sourceforge.net/lportal/liferay-portal-4.3.3.war"/>
	<property name="liferay.war" value="liferay-portal-4.3.3.war"/>
	<property name="liferay.mail.username" value="nobody" />
	<property name="liferay.mail.password" value="password" />
	<property name="liferay.mail.host" value="localhost" />
	<property name="liferay.portal.war.dir" value="${liferay.jboss.home}/server/${liferay.jboss.server.name}/deploy/liferay-portal.war"/>
	<property name="liferay.autodeploy.dir" value="${liferay.jboss.dir}/deploy"/>
	<property name="liferay.theme.name" value="cagrid-minimal"/>
	
	<property name="liferay.debug" value="true"/>
	
	<path id="liferay.compile.cp">
		<path refid="db.compile.cp"/>
		<pathelement location="${db.classes.dir}"/>
		<pathelement location="${security.classes.dir}"/>
		<fileset dir="${liferay.lib.dir}">
			<include name="portal-impl.jar"/>
			<include name="portal-kernel.jar"/>
			<include name="portal-service.jar"/>
		</fileset>
		<fileset dir="${aggr.lib.dir}">
			<include name="cagrid/cog-jglobus.jar"/>
		</fileset>
		<fileset dir="${aggr.lib.dir}/globus">
			<patternset refid="globus.crypto.jars"/>
		</fileset>		
		<fileset dir="${portlets.lib.dir}">
			<include name="servlet-api.jar"/>
		</fileset>
	</path>
	
	<target name="liferay:compile" depends="db:compile, security:compile">
		<mkdir dir="${liferay.classes.dir}" />
		<javac srcdir="${liferay.src.java.dir}" destdir="${liferay.classes.dir}"
			debug="${liferay.debug}">
			<classpath refid="liferay.compile.cp" />
		</javac>	
	</target>
	
	<target name="liferay:jar" depends="liferay:compile">
		<jar basedir="${liferay.classes.dir}" destfile="${liferay.build.dir}/cagrid-portal-liferay.jar"/>
	</target>
	
	<target name="liferay:jar-resources">
	
		<mkdir dir="${liferay.build.dir}/resources"/>
		
		<copy todir="${liferay.build.dir}/resources">
			<fileset dir="${db.dir}/etc">
				<include name="*.properties" />
				<include name="*.xml" />
			</fileset>
			<fileset dir="${security.dir}/etc">
				<include name="*.xml" />
			</fileset>
			<fileset dir="${liferay.dir}/etc">
				<include name="*.xml" />
			</fileset>		
		</copy>
	
		<jar basedir="${liferay.build.dir}/resources" destfile="${liferay.build.dir}/cagrid-portal-liferay-resources.jar"/>
		
	</target>
	
	<target name="liferay:deploy-authn" depends="db:jar, liferay:jar, liferay:jar-resources, security:jar">
		
		<copy todir="${liferay.root.context.dir}/WEB-INF/lib" overwrite="true" flatten="true">
		
			<fileset dir="${db.build.dir}">
				<include name="cagrid-portal-domain.jar"/>
				<include name="cagrid-portal-dao.jar"/>
			</fileset>
			
			<fileset dir="${security.build.dir}">
				<include name="cagrid-portal-security.jar"/>
			</fileset>
		
			<fileset dir="${liferay.build.dir}">
				<include name="cagrid-portal-liferay.jar"/>
				<include name="cagrid-portal-liferay-resources.jar"/>
			</fileset>
			
			<fileset dir="${db.lib.dir}">
				<include name="hibernate/annotations/*.jar"/>
				<include name="spring/spring-aspects.jar"/>
			</fileset>

		</copy>
		
		<copy todir="${liferay.jboss.home}/server/${liferay.jboss.server.name}/lib/ext" overwrite="true" flatten="true">
			<fileset dir="${aggr.lib.dir}">
				<include name="cagrid/cog-jglobus.jar"/>
			</fileset>
			
			<fileset dir="${aggr.lib.dir}/globus">
				<patternset refid="globus.crypto.jars"/>
			</fileset>
			
			<fileset dir="${db.build.dir}">
				<include name="cagrid-portal-domain.jar"/>
			</fileset>			
			
		</copy>
		
		<copy todir="${liferay.root.context.dir}/WEB-INF/classes" overwrite="true">
			<fileset dir="${liferay.src.war.dir}/WEB-INF/classes">
				<include name="*.xml"/>
				<include name="*.properties"/>
			</fileset>
			
			<filterset>
				<filter token="LIFERAY_JBOSS_DEPLOY_DEST_DIR" value="${liferay.jboss.deploy.dest.dir}" />
				<filter token="LIFERAY_AUTODEPLOY_DIR" value="${liferay.autodeploy.dir}" />
				<filter token="LIFERAY_ADMIN_PASSWORD" value="${liferay.admin.password}" />
				<filter token="LIFERAY_ADMIN_USERNAME" value="${liferay.admin.username}" />
			</filterset>
			
		</copy>
		
		<!-- This is need on windows if user.home is used to set up the autodeploy path. -->
		<replaceregexp file="${liferay.root.context.dir}/WEB-INF/classes/portal-ext.properties" 
			match="\\" replace="\/" flags="g"/>

		<!-- This is purposely not included in cagrid-portal-liferay-resources.jar so that
		     administrators can easily change these properties. 
		     -->		
		<antcall target="create-cagridportal-properties">
			<param name="target.dir" value="${liferay.root.context.dir}/WEB-INF/classes/cagridportal.properties"/>
		</antcall>
		
		<copy todir="${liferay.root.context.dir}/WEB-INF" overwrite="true">
			<fileset dir="${liferay.src.war.dir}/WEB-INF">
				<include name="applicationContext-acegi-security.xml"/>
				<include name="web.xml"/>
				<include name="lib/acegi-security-1.0.3.jar"/>
			</fileset>
		</copy>
		
	</target>
	
	<target name="liferay:clean">
		<delete dir="${liferay.build.dir}"/>
	</target>
	
	<target name="liferay:test-jboss-zip">
		 <condition property="liferay.jboss.zip.available">
		 	<available file="${liferay.jboss.zip}" type="file"/>
		 </condition>
	</target>
	
	<target name="liferay:download-jboss" unless="liferay.jboss.zip.available" depends="liferay:test-jboss-zip">
		<mkdir dir="${liferay.jboss.dir}"/>
		<get src="${liferay.jboss.download.url}" dest="${liferay.jboss.zip}" verbose="on"/>
	</target>
	
	<target name="liferay:test-jboss">
		 <condition property="liferay.jboss.available">
		 	<available file="${liferay.jboss.home}" type="dir"/>
		 </condition>
	</target>

	<target name="liferay:unzip-jboss" unless="liferay.jboss.available" depends="liferay:test-jboss">
		<mkdir dir="${liferay.jboss.dir}"/>
		<unzip src="${liferay.jboss.zip}" dest="${liferay.jboss.dir}"/>
	</target>
	
	<target name="liferay:install-jboss" depends="liferay:test-jboss">
		<if>
			<not>
				<isset property="liferay.jboss.available"/>
			</not>
			<then>
				<echo>Installing JBoss</echo>

				<antcall target="liferay:download-jboss"/>
				<antcall target="liferay:unzip-jboss"/>

			</then>
		</if>
	</target>
	
	<target name="liferay:configure-jboss-classpath">
		<!-- No DTD or Schema needed. -->
		<property name="config.file" value="${liferay.jboss.home}/server/${liferay.jboss.server.name}/conf/jboss-service.xml"/>
		<xmltask source="${config.file}" dest="${config.file}">
			<remove path="/server/classpath"/>
			<insert path="/server/mbean[1]" position="before">
				<![CDATA[
	<classpath archives="*" codebase="${jboss.server.lib.url:lib}/ext"/>
	<classpath archives="*" codebase="${jboss.server.lib.url:lib}"/>				
				]]>
			</insert>
		</xmltask>
			
	</target>
	
	<target name="liferay:configure-jboss-root">
	
		<delete file="${liferay.jboss.home}/server/${liferay.jboss.server.name}/deploy/jbossweb-tomcat55.sar/ROOT.war"/>
	
		<!-- Downloaded DTD to tools/ant/resources/web-app_2_3.dtd -->
		<property name="config.file" value="${liferay.jboss.home}/server/${liferay.jboss.server.name}/deploy/jbossweb-tomcat55.sar/conf/web.xml"/>
		<echo>Config File: ${config.file}</echo>
		<xmltask preservetype="true" source="${config.file}" dest="${config.file}" failWithoutMatch="true">
			<xmlcatalog refid="portal.catalog"/>
		
			<replace path="/*[local-name()='web-app']/*[local-name()='servlet' and ./*[local-name()='servlet-name' and text()='default']]">
				<![CDATA[
   <servlet xmlns="http://java.sun.com/xml/ns/j2ee">
      <servlet-name>default</servlet-name>
      <servlet-class>org.apache.catalina.servlets.DefaultServlet</servlet-class>
      <init-param>
         <param-name>debug</param-name>
         <param-value>0</param-value>
      </init-param>
      <init-param>
         <param-name>listings</param-name>
         <param-value>false</param-value>
      </init-param>
      <init-param>
         <param-name>input</param-name>
         <param-value>4096</param-value>
      </init-param>
      <init-param>
         <param-name>output</param-name>
         <param-value>4096</param-value>
      </init-param>
      <load-on-startup>1</load-on-startup>
   </servlet>
				]]>
			</replace>
		</xmltask>		
	</target>
	
	<target name="liferay:create-liferay-datasource">
		<concat destfile="${liferay.jboss.home}/server/${liferay.jboss.server.name}/deploy/liferay-ds.xml" append="false"><![CDATA[<datasources>
   <local-tx-datasource>
     <jndi-name>jdbc/LiferayPool</jndi-name>
     <connection-url>
         ${liferay.db.url}?useUnicode=true&amp;characterEncoding=UTF-8
     </connection-url>
     <driver-class>${liferay.db.driver}</driver-class>
     <user-name>${liferay.db.username}</user-name>
     <password>${liferay.db.password}</password>
     <min-pool-size>0</min-pool-size>
   </local-tx-datasource>
</datasources>			
			]]>
		</concat>
	</target>
	
	<target name="liferay:configure-jboss-mail-service">
		<concat destfile="${liferay.jboss.home}/server/${liferay.jboss.server.name}/deploy/mail-service.xml" append="false"><![CDATA[<server>
	<mbean code="org.jboss.mail.MailService" name="jboss:service=MailSession">
		<attribute name="JNDIName">mail/MailSession</attribute>
		<attribute name="User">${liferay.mail.username}</attribute>
		<attribute name="Password">${liferay.mail.password}</attribute>
		<attribute name="Configuration">
			<configuration>
				<property name="mail.store.protocol" value="imap" />
				<property name="mail.transport.protocol" value="smtp" />
				<property name="mail.imap.host" value="${liferay.mail.host}" />
				<property name="mail.pop3.host" value="${liferay.mail.host}" />
				<property name="mail.smtp.host" value="${liferay.mail.host}" />
			</configuration>
		</attribute>
	</mbean>
</server>		
			]]>
		</concat>
	</target>
	
	<target name="liferay:configure-jboss-jaas">
		<!-- Downloaded DTD to tools/ant/resources/security_config.dtd -->
		<property name="config.file" value="${liferay.jboss.home}/server/${liferay.jboss.server.name}/conf/login-config.xml"/>
		<xmltask preservetype="true" source="${config.file}" dest="${config.file}">
			<xmlcatalog refid="portal.catalog"/>
			<remove path="/policy/application-policy[@name='other']"/>
		</xmltask>	
	</target>
		
		
	<target name="liferay:configure-jboss-jca-service">
		<!-- No DTD or Schema needed. -->
		<property name="config.file" value="${liferay.jboss.home}/server/${liferay.jboss.server.name}/deploy/jbossjca-service.xml"/>
		<xmltask source="${config.file}" dest="${config.file}">
			<replace path="/server/mbean[@name='jboss.jca:service=CachedConnectionManager']/attribute[@name='Debug']/text()" withText="false"/>
		</xmltask>	
	</target>
	
	<target name="liferay:configure-jboss-jms-service">
		<concat destfile="${liferay.jboss.home}/server/${liferay.jboss.server.name}/deploy/jms/jbossmq-destinations-service.xml" append="false"><![CDATA[<?xml version="1.0"?>
<server></server>]]></concat>
	</target>	
	
	<target name="liferay:configure-jboss-tomcat">
		<if>
			<istrue value="${liferay.jboss.configure.connectors}"/>
			<then>
				<!-- No DTD or Schema needed. -->
				<property name="config.file" value="${liferay.jboss.home}/server/${liferay.jboss.server.name}/deploy/jbossweb-tomcat55.sar/server.xml"/>
				<xmltask source="${config.file}" dest="${config.file}">
				
					<!-- Remove all the Connector elements except AJP/1.3  -->
					<remove path="/Server/Service[@name='jboss.web']/Connector[not(@protocol='AJP/1.3')]"/>
				
					<insert path="/Server/Service[@name='jboss.web']/Engine[@name='jboss.web']" position="before">
					<![CDATA[
		      <Connector acceptCount="100" address="$${jboss.bind.address}" connectionTimeout="20000" 
		      		disableUploadTimeout="true" emptySessionPath="true" enableLookups="false" 
		      		maxHttpHeaderSize="8192" maxThreads="250" port="${liferay.http.port}" 
		      		redirectPort="${liferay.https.port}" strategy="ms"/>
					]]>
					</insert>
				
					<insert path="/Server/Service[@name='jboss.web']/Engine[@name='jboss.web']" position="before">
					<![CDATA[
		      <Connector port="${liferay.https.port}" address="$${jboss.bind.address}"
		           maxThreads="100" strategy="ms" maxHttpHeaderSize="8192"
		           emptySessionPath="true"
		           scheme="https" secure="true" clientAuth="false" 
		           keystoreFile="${liferay.https.keystore.path}"
		           keystorePass="${liferay.https.keystore.password}" sslProtocol="TLS" />			
					]]>
					</insert>
					
				</xmltask>
			</then>
		</if>
	</target>
	
	<target name="liferay:copy-startup-scripts">
		<if>
			<istrue value="${liferay.jboss.deploy.scripts}"/>
			<then>
				<copy todir="${liferay.jboss.home}/bin" overwrite="true">
					<fileset dir="${liferay.src.scripts.dir}">
						<include name="run.sh"/>
						<include name="run.bat"/>
					</fileset>
				</copy>
			</then>
		</if>
	</target>

     <target name="liferay:configure-startup-scripts">
        <if>
            <istrue value="${liferay.jboss.deploy.scripts}"/>
            <then>
                <chmod dir="${liferay.jboss.home}/bin"
                       perm="u+x"
                       includes="*.sh">
                </chmod>
            </then>
        </if>
    </target>

    <target name="liferay:configure-jboss">
		<antcall target="liferay:configure-jboss-classpath"/>	
		<antcall target="liferay:configure-jboss-root"/>
		<antcall target="liferay:configure-jboss-mail-service"/>
		<antcall target="liferay:configure-jboss-jaas"/>
		<antcall target="liferay:configure-jboss-jca-service"/>
		<antcall target="liferay:configure-jboss-jms-service"/>
		<antcall target="liferay:create-liferay-datasource"/>
		<antcall target="liferay:copy-liferay-ext-jars"/>
		<antcall target="liferay:configure-jboss-tomcat"/>
		<antcall target="liferay:copy-startup-scripts"/>
        <antcall target="liferay:configure-startup-scripts"/>
    </target>
	
	<target name="liferay:check-dependencies-downloaded">
		<condition property="liferay.dependencies.zip.available">
			<available file="${liferay.downloads.dir}/${liferay.dependencies.zip}" type="file"/>
		</condition>
	</target>
	
	<target name="liferay:download-dependencies" unless="liferay.dependencies.zip.available" depends="liferay:check-dependencies-downloaded">
		<mkdir dir="${liferay.downloads.dir}"/>
		<get src="${liferay.dependencies.download.url}" dest="${liferay.downloads.dir}/${liferay.dependencies.zip}"  verbose="on"/>
	</target>
	
	<target name="liferay:check-war-downloaded">
		<condition property="liferay.war.available">
			<available file="${liferay.downloads.dir}/${liferay.war}" type="file"/>
		</condition>
	</target>
	
	<target name="liferay:download-war" unless="liferay.war.available" depends="liferay:check-war-downloaded">
		<mkdir dir="${liferay.downloads.dir}"/>
		<get src="${liferay.war.download.url}" dest="${liferay.downloads.dir}/${liferay.war}" verbose="on"/>
	</target>
	
	<target name="liferay:copy-liferay-ext-jars" depends="liferay:download-dependencies">
		<mkdir dir="${liferay.jboss.home}/server/${liferay.jboss.server.name}/lib/ext"/>
		<unzip src="${liferay.downloads.dir}/${liferay.dependencies.zip}" dest="${liferay.jboss.home}/server/${liferay.jboss.server.name}/lib/ext"/>
		<copy file="${liferay.db.driver.path}" todir="${liferay.jboss.home}/server/${liferay.jboss.server.name}/lib/ext"/>
	</target>
	
	<target name="liferay:deploy-liferay-portal-war" depends="liferay:download-war">
	
		<mkdir dir="${liferay.portal.war.dir}"/>
		<unzip src="${liferay.downloads.dir}/${liferay.war}" dest="${liferay.portal.war.dir}"/>
		
		<move todir="${liferay.jboss.home}/lib">
			<fileset dir="${liferay.portal.war.dir}/WEB-INF/lib">
				<include name="dom4j.jar"/>
				<include name="jaxen.jar"/>
			</fileset>
		</move>
				
		<move file="${liferay.portal.war.dir}/WEB-INF/lib/commons-collections.jar" todir="${liferay.jboss.home}/server/${liferay.jboss.server.name}/lib"/>
		
		<delete>
			<fileset dir="${liferay.jboss.home}/server/${liferay.jboss.server.name}/lib">
				<include name="hibernate3.jar"/>
				<include name="jboss-hibernate.jar"/>
			</fileset>
		</delete>
		
		<delete file="${liferay.portal.war.dir}/WEB-INF/lib/log4j.jar"/>
				
	</target>
	
	<target name="liferay:add-cagrid-category">
		<!-- Downloaded to tools/ant/resources/liferay-display_4_0_0.dtd -->
		<property name="config.file" value="${liferay.portal.war.dir}/WEB-INF/liferay-display.xml"/>
		<xmltask source="${config.file}" dest="${config.file}" preservetype="true">
			<xmlcatalog refid="portal.catalog"/>
			<remove path="/display/category[@name='category.cagrid']"/>
			<insert path="/display/category[@name='category.cms']" position="before">
			<![CDATA[
	<category name="category.cagrid">
		<portlet id="cagriddirectauthn_WAR_cagridportlets" />
		<portlet id="cagridgreeting_WAR_cagridportlets" />
		<portlet id="cagridregistration_WAR_cagridportlets" />
		<portlet id="cagridnewssummary_WAR_cagridportlets" />
		<portlet id="cagridnews_WAR_cagridportlets" />
		<portlet id="cagridstatus_WAR_cagridportlets" />
		<portlet id="cagridmap_WAR_cagridportlets" />
		<portlet id="cagriddiagnostics_WAR_cagridportlets" />
	    <portlet id="cagriddiscovery_WAR_cagridportlets" />
		<portlet id="cabigtools_WAR_cagridportlets" />
		<portlet id="cagridquery_WAR_cagridportlets" />
		<portlet id="WelcomeToCaGridPortal_WAR_cagridportlets" />
		<portlet id="cagridinterestinglinks_WAR_cagridportlets" />
	</category>
			]]>
			</insert>
		</xmltask>
	</target>
	
	<target name="liferay:configure-liferay-messages">
		<mkdir dir="${liferay.portal.war.dir}/WEB-INF/classes/content"/>
		<propertyfile file="${liferay.portal.war.dir}/WEB-INF/classes/content/Language-ext.properties">
			<entry key="category.cagrid" value="caGrid"/>
		</propertyfile>
	</target>
	
	<target name="liferay:install-liferay">
		<antcall target="liferay:install-jboss"/>
		<antcall target="liferay:configure-jboss"/>
		<antcall target="liferay:deploy-liferay-portal-war"/>
		<antcall target="liferay:add-cagrid-category"/>
		<antcall target="liferay:configure-liferay-messages"/>
	</target>

	<target name="liferay:deploy-portlets" depends="portlets:war">
		<copy file="${portlets.build.dir}/cagridportlets.war" todir="${liferay.autodeploy.dir}" overwrite="true"/>
	</target>
	
	<target name="liferay:war-layouts">
		<mkdir dir="${liferay.build.dir}"/>	
		<jar destfile="${liferay.build.dir}/cagridportallayouts.war" basedir="${liferay.src.layouts.dir}"/>
	</target>
	
	<target name="liferay:deploy-layouts" depends="liferay:war-layouts">
		<copy file="${liferay.build.dir}/cagridportallayouts.war" todir="${liferay.autodeploy.dir}" overwrite="true"/>
	</target>
	
	<target name="liferay:war-theme">
		<mkdir dir="${liferay.build.dir}"/>	
		<jar destfile="${liferay.build.dir}/${liferay.theme.name}.war" basedir="${liferay.src.themes.dir}/${liferay.theme.name}"/>
	</target>
	
	<target name="liferay:deploy-theme" depends="liferay:war-theme">
		<copy file="${liferay.build.dir}/${liferay.theme.name}.war" todir="${liferay.autodeploy.dir}" overwrite="true"/>
	</target>
	
	<target name="liferay:deploy-all">
		<antcall target="liferay:deploy-authn"/>
		<antcall target="liferay:deploy-layouts"/>
		<antcall target="liferay:deploy-theme"/>
		<antcall target="liferay:deploy-portlets"/>
	</target>

	
</project>